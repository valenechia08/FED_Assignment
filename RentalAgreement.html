<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiokLah!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="Vendor.css" />
    <style>
      :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#eceff5;
      --shadow:0 10px 28px rgba(16,24,40,.10);
      --green:#039855;
      --green-bg:#e8f8ef;
      --red:#d92d20;
      --red-bg:#ffe7ea;
      --radius:14px;
    }
    .wrap{
      max-width: 1100px;
      margin: auto;
      margin-top:15px;
    }


    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background-color: #ffdfae;
    }

    .card-title{
      font-size:20px;
      margin-left:10px;
      margin-top:10px;
      margin-bottom:10px;
      font-weight:700;
      color:#344054;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    /* FILTER DROPDOWN */
    select{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
    }

    /* ADD BUTTON */
    .add-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:none;
      background:#ff8c3a;
      color:white;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
    }

    .list{display:flex;flex-direction:column;}

    .row{
      display:flex;
      align-items:center;
      gap:18px;
      padding:22px 26px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .row:last-child{border-bottom:none;}
    .row:hover{background:#fafbff;}

    .icon{
      width:38px;
      height:38px;
      border-radius:12px;
      background:#f1f3f9;
      display:grid;
      place-items:center;
    }

    .main{
      flex:1;
      min-width:0;
    }

    .top{
      display:flex;
      gap:10px;
      align-items:baseline;
    }

    .aid{
  font-size: 15px;
  font-weight: 700;
}

    .address{
      font-size:15px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sub{
      margin-top:8px;
      font-size:14px;
      color:var(--text);
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      font-size:13px;
      padding: 7px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }

    .active{background:var(--green-bg);color:var(--green);border:2px solid var(--green)}
    .expired{background:var(--red-bg);color:var(--red);border:1.5px solid var(--red)}
    .badge.pending{
  background: #fffab1;
  color: #d79e00;
  border: 1.5px solid rgba(181,71,8,.25);
}


    .arrow-btn{
    background: none;
    border: none;
    font-size: 20px;
    font-weight: 700;
    color: #98a2b3;
    cursor: pointer;
    padding: 4px 6px;
    line-height: 1;
    transition: transform .15s ease, color .15s ease;
  }

  .arrow-btn:hover{
    font-size: 22px;
    color: #475467;
    transform: translateX(3px);
}

.end-date{
  font-weight: 700;
}
/* drawer styles */
  .drawer { position: fixed; inset: 0; display: none; z-index: 2000; }
  .drawer.show { display: block; }
  .drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
  .drawer-panel {
    position: absolute; top: 0; right: 0;
    height: 100%; width: min(420px, 92vw);
    background: #fff;
    box-shadow: -20px 0 40px rgba(0,0,0,.18);
    display: flex; flex-direction: column;
  }
  .drawer-head{
    padding: 14px 16px;
    border-bottom: 1px solid var(--line);
    display:flex; align-items:center; justify-content: space-between;
    background: #ffdfae;
  }
  .drawer-title{ font-weight: 900; color:#344054; font-size: 16px; }
  .drawer-close{
    width: 34px; height: 34px; border-radius: 10px;
    border: 1px solid var(--line);
    background: #fff; cursor: pointer; font-weight: 900;
  }
  .drawer-body{ padding: 16px; overflow:auto; display:grid; gap: 10px; }
  .drow{ display:flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px dashed var(--line); }
  .dk{ color: var(--muted); font-weight: 800; font-size: 12.5px; }
  .dv{ color: var(--text); font-weight: 900; font-size: 13.5px; text-align:right; word-break: break-word; }
  .dnotes{ margin-top: 8px; border: 1px solid var(--line); border-radius: 12px; padding: 12px; background:#fafbff; }
  .dnotes-title{ font-weight: 900; color:#344054; margin-bottom: 8px; }
  .dnotes-body{ color: var(--text); font-weight: 600; white-space: pre-wrap; line-height: 1.4; }
  .drawer-actions{ margin-top: 6px; display:flex; justify-content:flex-end; }
  .btn-lite{
    height: 40px; padding: 0 14px; border-radius: 12px;
    border: none; background:#ff8c3a; color:#fff; font-weight: 900; cursor:pointer;
  }

  /* small improvement for row click: only arrow opens drawer */
  .row { cursor: default; }
  .arrow-btn { cursor: pointer; }
  @media (max-width: 992px) {
  .drawer-body .drow {
  display: flex;
  flex-direction: column; /* Stack vertically on mobile */
  gap: 8px;
}
}
    </style>
  </head>
  <body>
    <!-- Vendor Home -->
     <section class="container vendornav">
      <nav class="navrectangle">
        <header class="brand">
          <img src="images/ShiokLahTransparent.png" alt="ShiokLah">
        </header>

       <ul class="navBar">
        <li class="main toggle" data-link="PerformanceDashboard.html">
          <div class="title-row"><img src="images/statisctics.png" data-default="images/statisctics.png"
      data-active="images/orangestatisctics.png" alt="ShiokLah">Dashboard</div>
        </li>
        
        <li class="main toggle" data-link="VendorEditMenu.html">
          <div class="title-row"><img src="images/menu (2).png" data-default="images/menu (2).png"
      data-active="images/orangemenu.png" alt="ShiokLah">Edit Menu</div>
      </li>

        <li class="main toggle">
          <div class="title-row"><img src="images/user.png" data-default="images/user.png"
      data-active="images/orangeuser.png" alt="ShiokLah">Profile <span class="arrow"><img src="images/down.png" ></span></div>
          <ul class="submenu">
            <li><button class="subpoint" data-link="StallHygieneGrades.html">‚Ä¢ Hygiene History</button></li>
            <li><button class="subpoint" data-link="VendorOrders.html">‚Ä¢ Orders</button></li>
            <li><button class="subpoint" data-link="RentalAgreement.html">‚Ä¢ Rental Agreements</button></li>
            <li><button class="subpoint" data-link="CustomerFeedback.html">‚Ä¢ Customer Feedback</button></li>
            <li><button class="subpoint">‚Ä¢ Settings</button></li>
          </ul>
        </li>

        <li class="main toggle logout">
          <button onclick="window.location.href='login.html'" class="subpoint"><img src="images/logout.png" data-default="images/logout.png"
      data-active="images/orangelogout.png" alt="ShiokLah">Log Out</button>
        </li>
      </ul>

    </nav>

      <nav class="mobile-nav vendornav">
        <div class="mobile-nav-item active" data-link="PerformanceDashboard.html">
          <span>üè†</span>
          <small>Home</small>
        </div>

        <div class="mobile-nav-item" data-link="VendorEditMenu.html">
          <span>üçΩÔ∏è</span>
          <small>Edit Menu</small>
        </div>

        <div class="mobile-nav-item" data-link="VendorOrders.html">
          <span>üë§</span>
          <small>Orders</small>
        </div>
      </nav>

  <main class="contents">
  <div class="wrap">
    <section class="card">
      <div class="card-header">
        <div class="card-title">Rental Agreements</div>

        <div class="header-actions">
          <!-- STATUS FILTER -->
          <select id="statusFilter">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="expired">Expired</option>
            <option value="pending">Pending Renewal</option>
          </select>

          <!-- ADD BUTTON -->
          <button class="add-btn" id="addAgreementBtn" type="button">+</button>
        </div>
      </div>

      <div class="list" id="agreementList"></div>
        <!-- rows will be rendered here -->
      </div>
    </section>
  </div>
   <!-- RIGHT DRAWER (view more) -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer-panel">
      <div class="drawer-head">
        <div class="drawer-title" id="dTitle">Agreement</div>
        <button class="drawer-close" id="drawerClose" type="button">‚úï</button>
      </div>

      <div class="drawer-body">
        <div class="drow"><div class="dk">Agreement ID</div><div class="dv" id="dAID">‚Äî</div></div>
        <div class="drow"><div class="dk">Centre</div><div class="dv" id="dCentre">‚Äî</div></div>
        <div class="drow"><div class="dk">Store Location</div><div class="dv" id="dLoc">‚Äî</div></div>
        <div class="drow"><div class="dk">Store Address</div><div class="dv" id="dAddr">‚Äî</div></div>
        <div class="drow"><div class="dk">Trade Type</div><div class="dv" id="dTrade">‚Äî</div></div>
        <div class="drow"><div class="dk">Rent</div><div class="dv" id="dRent">‚Äî</div></div>
        <div class="drow"><div class="dk">Start Date</div><div class="dv" id="dStart">‚Äî</div></div>
        <div class="drow"><div class="dk">End Date</div><div class="dv" id="dEnd">‚Äî</div></div>
        <div class="drow"><div class="dk">Status</div><div class="dv" id="dStatus">‚Äî</div></div>

        <div class="dnotes">
          <div class="dnotes-title" id="dNoteTitle">Notes</div>
          <div class="dnotes-body" id="dNotes">‚Äî</div>
        </div>

        <div class="drawer-actions">
          <button class="btn-lite" id="editBtn" type="button">Edit</button>
        </div>
      </div>
    </div>
  </aside>
</main>
  <script>
      document.getElementById("addAgreementBtn").addEventListener("click", () => {
        // change this to your actual page name
        window.location.href = "AddRentalAgreement.html";
      });
  </script>
    <script type="module" src="Master_page_javascript.js"></script>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoYoGP4NYJPHqA-kV_swajQ4LSQYdyWV4",
    authDomain: "grp3fedapp.firebaseapp.com",
    databaseURL: "https://grp3fedapp-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "grp3fedapp",
    storageBucket: "grp3fedapp.firebasestorage.app",
    messagingSenderId: "791146838729",
    appId: "1:791146838729:web:446baee191feeb036e2b18",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const $ = (id) => document.getElementById(id);

  // ‚úÖ robust username across tabs
  function getCurrentUsername() {
    return (
      localStorage.getItem("loggedInUser") ||
      sessionStorage.getItem("loggedInUser") ||
      ""
    ).trim();
  }

  const username = getCurrentUsername();
  if (!username) {
    alert("No logged-in user found. Please log in again.");
    window.location.href = "login.html";
  }

  const listEl = $("agreementList");
  const filterEl = $("statusFilter");
  let allAgreements = []; // store for filtering

  function formatDate(iso) {
    if (!iso) return "‚Äî";
    // keep simple: ISO yyyy-mm-dd -> dd-MMM-yyyy
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return d.toLocaleDateString("en-SG", { day: "2-digit", month: "short", year: "numeric" });
  }

  function normalizeStatus(s) {
    const v = String(s || "").toLowerCase().trim();
    if (v === "active" || v === "expired" || v === "pending") return v;
    // if your create page uses "pending renewal" text, map it:
    if (v.includes("pending")) return "pending";
    return "active";
  }

  function badgeHTML(status) {
    const st = normalizeStatus(status);
    if (st === "active") return `<span class="badge active">Active</span>`;
    if (st === "expired") return `<span class="badge expired">Expired</span>`;
    return `<span class="badge pending">Pending Renewal</span>`;
  }

  function render(list) {
    listEl.innerHTML = "";

    if (!list.length) {
      listEl.innerHTML = `<div style="padding:18px 22px; color: var(--muted); font-weight:700;">No rental agreements found.</div>`;
      return;
    }

    list
      // newest first
      .sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0))
      .forEach((ag) => {
        const row = document.createElement("div");
        row.className = "row";

        row.innerHTML = `
          <div class="icon">üìÑ</div>

          <div class="main">
            <div class="top">
              <div class="aid">${ag.AID || "‚Äî"}</div>
              <div class="address">${ag.storeAddress || "‚Äî"}</div>
            </div>
            <div class="sub">
              End Date: <span class="end-date">${formatDate(ag.endDate)}</span>
            </div>
          </div>

          <div class="right">
            ${badgeHTML(ag.status)}
            <button class="arrow-btn" type="button" title="View details">‚Ä∫</button>
          </div>
        `;

        // arrow opens drawer
        row.querySelector(".arrow-btn").addEventListener("click", (e) => {
          e.stopPropagation();
          openDrawer(ag);
        });

        listEl.appendChild(row);
      });
  }
  onValue(ref(db, `members/${username}/rentalAgreements`), (snap) => {
    const data = snap.val() || {};
    const agreements = Object.values(data);

    // Optional: sort by endDate / updatedAt
    agreements.sort((a, b) => (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));

    listEl.innerHTML = agreements.length
  ? agreements.map(ag => render(ag)).join("")
  : `<div style="padding:16px;color:#667085">No rental agreements yet.</div>`;
  });
  function applyFilter() {
    const v = filterEl.value;
    if (v === "all") return render(allAgreements);

    const filtered = allAgreements.filter(a => normalizeStatus(a.status) === v);
    render(filtered);
  }

  // Drawer logic
  const drawer = $("drawer");
  const overlay = $("drawerOverlay");
  const closeBtn = $("drawerClose");

  function openDrawer(ag) {
    $("dTitle").textContent = `Agreement ${ag.AID || ""}`;
    $("dAID").textContent = ag.AID || "‚Äî";
    $("dCentre").textContent = ag.centre || "‚Äî";
    $("dLoc").textContent = ag.storeLocation || "‚Äî";
    $("dAddr").textContent = ag.storeAddress || "‚Äî";
    $("dTrade").textContent = ag.tradeType || "‚Äî";
    $("dRent").textContent = (ag.rent != null && !isNaN(ag.rent)) ? `$${Number(ag.rent).toFixed(2)}` : "‚Äî";
    $("dStart").textContent = formatDate(ag.startDate);
    $("dEnd").textContent = formatDate(ag.endDate);
    $("dStatus").textContent = normalizeStatus(ag.status);
    $("dNoteTitle").textContent = ag.noteTitle?.trim() ? ag.noteTitle.trim() : "Notes";
    $("dNotes").textContent = ag.notes?.trim() ? ag.notes.trim() : "‚Äî";

    // optional: renew button (send AID along)
    $("editBtn").onclick = () => {
      window.location.href = `AddRentalAgreement.html?edit=${encodeURIComponent(ag.AID)}`;
    };


    drawer.classList.add("show");
    drawer.setAttribute("aria-hidden", "false");
  }

  function closeDrawer() {
    drawer.classList.remove("show");
    drawer.setAttribute("aria-hidden", "true");
  }

  overlay.addEventListener("click", closeDrawer);
  closeBtn.addEventListener("click", closeDrawer);

  // Button actions
  $("addAgreementBtn").addEventListener("click", () => {
    window.location.href = "AddRentalAgreement.html";
  });

  filterEl.addEventListener("change", applyFilter);

  // ‚úÖ Listen to this user's agreements
  const agreementsRef = ref(db, `members/${username}/rentalAgreements`);
  onValue(agreementsRef, (snap) => {
    const data = snap.val() || {};
    // convert object map -> array
    allAgreements = Object.values(data);
    applyFilter();
  });


  //Navigation
    // Helper: get icon for a main item (normal or logout)
  function getMainIcon(main) {
    return main.querySelector(".title-row img") || main.querySelector(".subpoint img");
  }

  // Reset all active states (except optional keep param)
  function resetAllActive(keepMain = null) {
    document.querySelectorAll(".main").forEach(m => {
      if (m !== keepMain) m.classList.remove("active");

      const ic = getMainIcon(m);
      if (ic && ic.dataset.default) ic.src = ic.dataset.default;

      // close any submenu
      const sm = m.querySelector(".submenu");
      if (sm) sm.style.display = "none";
    });
  }

  // MAIN NAV LOGIC
  document.querySelectorAll(".main").forEach(main => {
    const icon = getMainIcon(main);

    // Hover icon change (only if not active)
    if (icon && icon.dataset.active) {
      main.addEventListener("mouseenter", () => {
        if (!main.classList.contains("active")) icon.src = icon.dataset.active;
      });

      main.addEventListener("mouseleave", () => {
        if (!main.classList.contains("active")) icon.src = icon.dataset.default;
      });
    }

    const titleRow = main.querySelector(".title-row");
    const submenu = main.querySelector(".submenu");

    // If it has submenu (Profile), clicking title toggles open/close
    if (submenu && titleRow) {
      titleRow.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = main.classList.contains("active");

        // close others first
        resetAllActive(main);

        // toggle this one
        if (isOpen) {
          main.classList.remove("active");
          submenu.style.display = "none";
          if (icon && icon.dataset.default) icon.src = icon.dataset.default;
        } else {
          main.classList.add("active");
          submenu.style.display = "block";
          if (icon && icon.dataset.active) icon.src = icon.dataset.active;
        }
      });

      return; // IMPORTANT: don't attach redirect to Profile main item
    }

    // If it's a normal clickable page (Dashboard/Edit Menu)
    const link = main.dataset.link;
    if (link) {
      main.addEventListener("click", () => {
        resetAllActive(main);
        main.classList.add("active");
        if (icon && icon.dataset.active) icon.src = icon.dataset.active;
        window.location.href = link;
      });
    }
  });

  // SUBMENU BUTTON REDIRECTS
  document.querySelectorAll(".subpoint[data-link]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = btn.dataset.link;
    });
  });

  // ARROW IMAGE HOVER (only where arrow exists)
  document.querySelectorAll(".title-row").forEach(row => {
    const arrowImg = row.querySelector(".arrow img");
    if (!arrowImg) return;

    row.addEventListener("mouseenter", () => {
      arrowImg.src = "images/orangedown.png";
    });
    row.addEventListener("mouseleave", () => {
      arrowImg.src = "images/down.png";
    });
  });

  // Optional: click outside to close dropdown
  document.addEventListener("click", () => {
    resetAllActive(null);
  });
</script>
  </body>
</html>