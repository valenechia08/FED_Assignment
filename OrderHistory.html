<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiokLah Dashboard</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&family=Open+Sans:wght@300..800&family=Roboto:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/jpeg" href="/images/ShiokLah(cropped).jpeg" />
    <link rel="stylesheet" href="Master_page_stylesheet.css" />
    <style>
      /* content */
      /* ==========================
        See More / Show Less Button
      ========================== */
  
      .see-more-btn {
        margin: 12px auto 0;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: #f1f5f9;          /* soft neutral */
        color: #334155;               /* slate text */
        font-family:  Arial,"Kodchasan";
        font-size: 12px;
        font-weight: 600;
        border: 1px solid #e2e8f0;
        border-radius: 999px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        transition:
          background 0.2s ease,
          transform 0.15s ease,
          box-shadow 0.15s ease;
      }

      .see-more-btn:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      }

      .see-more-btn:active {
        transform: scale(0.96);
      }

      .see-more-icon {
        font-size: 13px;
        transition: transform 0.25s ease;
      }

      /* rotate arrow when expanded */
      .see-more-btn.expanded .see-more-icon {
        transform: rotate(180deg);
      }


      .order-box {
        max-width: 600px;
        margin: 40px auto;
        padding: 80px 20px;
        background: #fff8f0;
        border: 2px dashed #ff8c3a;
        border-radius: 18px;
        text-align: center;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      .order-box h2 {
        font-size: 28px;
        font-weight: 700;
        color: #ff7a18;
        margin-bottom: 10px;
        font-family: "Montserrat", sans-serif;
      }

      .order-box p {
        font-size: 16px;
        color: #444;
        margin-bottom: 24px;
        font-family: "Kodchasan", Arial;
      }

      .order-box a {
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        color: white;
      }
      .order-btn {
        display: inline-block;
        margin: 20px auto 0;
        background: #ff8c3a;
        color: #fff;
        text-decoration: none;
        padding: 12px 40px;
        font-size: 15px;
        font-weight: 700;
        border-radius: 999px;
        transition:
          background 0.3s ease,
          transform 0.2s ease; /* enables animation */
      }

      .order-btn:hover {
        background: #e6762f;
        transform: scale(1.05); /* hover animation */
      }

      .teaser {
        margin: 20px 0;
        text-align: center;
      }

      .teaser img {
        width: 120px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .teaser img:hover {
        transform: scale(1.05);
      }

      .teaser p {
        font-size: 14px;
        color: #555;
        margin-top: 8px;
        font-style: italic;
      }

      .filter-box {
        margin: 15px auto;
        max-width: 400px;
        text-align: center;
      }

      .filter-box input {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #ff8c3a;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .filter-box input:focus {
        border-color: #e6762f;
      }
      .order-list {
        list-style: none;
        padding: 0;
        margin: 20px auto;
        max-width: 500px;
      }

      .order-list li {
        margin-bottom: 5px;
      }

      .order-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .order-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
      }

      .order-card .dish {
        font-weight: 600;
        font-size: 14px;
        color: #333;
      }

      .order-card .date {
        font-size: 13px;
        color: #777;
        font-style: italic;
      }

      /* ‚úÖ added cost styling (minimal change) */
      .order-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
      }
      .order-card .cost {
        font-size: 13px;
        color: #333;
        font-weight: 600;
      }

      /* -------------------- MOBILE RESPONSIVE -------------------- */
      /* .hamburger {
        display: none;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
      }
      .hamburger div {
        width: 25px;
        height: 3px;
        background: #111;
        border-radius: 2px;
      } */

      @media (max-width: 992px) {
        .main-content{
          padding:0 24px;
        }
        .order-box {
          margin: 18px 12px;
          padding: 24px 16px;
          border-radius: 20px;
          box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
        }

        .order-box h2 {
          font-size: 20px;
          margin-bottom: 10px;
          text-align: center;
        }
        .order-box p {
          font-size: 13px;
          margin-bottom: 14px;
          text-align: center;
        }
        .order-btn {
          padding: 10px 20px;
          font-size: 13px;
          width: 100%;
          max-width: 320px;
          text-align: center;
        }
        .teaser img {
          width: 80px;
          border-radius: 14px;
        }
        .teaser p {
          font-size: 12px;
        }
        .order-list li {
          font-size: 13px;
          padding: 8px;
        }
        .hamburger {
          display: flex;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navrectangle">
      <div class="container">
        <div class="top-nav">
          <div class="nav-left">
            <div class="Logo">
              <img src="/images/ShiokLah(cropped).jpeg" alt="Logo" />
            </div>
          </div>

          <div class="nav-center">
            <ul class="menu" id="menu">
              <li class="menu-item">
                <a href="#">Home</a>
                <ul class="dropdown">
                  <li><a href="FED_ASG.html">Start Order</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Order History</a>
                <ul class="dropdown">
                  <li><a href="OrderHistory.html">Past Orders</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Profile</a>
                <ul class="dropdown">
                  <li><a href="UserProfile.html">Overview</a></li>
                  <li><a href="Analytics.html">Analytics & Reporting</a></li>
                  <li>
                    <a href="Customer_ReviewPage.html">Customer Feedback</a>
                  </li>
                  <li><a href="Customer_Favourties.html">Favourites</a></li>
                  <li>
                    <a href="Customer Vouchers and Rewards.html">Rewards</a>
                  </li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="SelectRole.html" id="logoutLink">Log Out</a>
              </li>
            </ul>
          </div>

          <div class="nav-right">
            <button class="reserve-btn">Reserve A Table</button>
            <div class="hamburger" id="hamburger">
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="nav-overlay" id="navOverlay"></div>
    <hr class="Nav-line" />
    <!-- end nav -->

    <!-- MAIN -->
    <main class="main-content">
      <!-- FIRST TIME REGISTERED USER -->
      <div class="order-box first-time">
        <h2>üõí No orders yet</h2>
        <p>Place your first order to see it here.</p>

        <div class="teaser">
          <img src="images/Malay Cuisine Picture.jpg" alt="Teaser Dish" />
          <p>Try our bestselling Nasi Lemak today!</p>
        </div>

        <small class="tagline">Your hawker favourites are just a click away!</small>
        <br />
        <a href="FED_ASG.html" class="order-btn">Start Ordering</a>
      </div>

      <!-- GUEST USER -->
      <div class="order-box guest">
        <h2>üë§ Guest User</h2>
        <p>
          You‚Äôre browsing as a guest. Sign up or log in to start ordering and
          track your history.
        </p>

        <div class="teaser">
          <img src="images/Chinese Cuisine Picture.jpg" alt="Guest Teaser" />
          <p>Join ShiokLah to unlock rewards!</p>
        </div>

        <small class="tagline">Create an account to enjoy hawker favourites anytime.</small>
        <br />
        <a href="login.html" class="order-btn">Sign Up / Log In</a>
      </div>

      <!-- REGISTERED USER WITH MULTIPLE ORDERS -->
      <div class="order-box registered">
        <h2>üì¶ Your Order History</h2>
        <p>Here are your recent orders:</p>

        <!-- Filter Box -->
        <div class="filter-box">
          <input
            type="text"
            id="orderFilter"
            placeholder="Filter orders by dish or date..."
          />
        </div>

        <!-- Order History List -->
        <ul id="orderList" class="order-list"></ul>
        <button id="toggleOrdersBtn" class="see-more-btn">
          <span class="see-more-text">See More Orders</span>
          <span class="see-more-icon">‚ñæ</span>
        </button>

        <small class="tagline">Keep enjoying your favourites ‚Äì we‚Äôll save them here!</small>
        <br />
        <a href="FED_ASG.html" class="order-btn">Order Again</a>
      </div>
    </main>

    <script type="module" src="Master_page_javascript.js"></script>
    <script type="module">
      /* ================================
        1. Import Firebase modules
      ================================ */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        query,
        orderByChild,
        equalTo,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      /* ================================
        Firebase configuration
        (REPLACE with your own config) DONE
      ================================ */
      const firebaseConfig = {
        apiKey: "AIzaSyCoYoGP4NYJPHqA-kV_swajQ4LSQYdyWV4",
        authDomain: "grp3fedapp.firebaseapp.com",
        databaseURL:
          "https://grp3fedapp-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grp3fedapp",
        storageBucket: "grp3fedapp.firebasestorage.app",
        messagingSenderId: "791146838729",
        appId: "1:791146838729:web:446baee191feeb036e2b18",
      };


      /* ================================
        Initialize Firebase
      ================================ */
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      document.addEventListener("DOMContentLoaded", () => {
        const orderList = document.getElementById("orderList");
        const filterInput = document.getElementById("orderFilter");

        const firstTimeBox = document.querySelector(".order-box.first-time");
        const guestBox = document.querySelector(".order-box.guest");
        const registeredBox = document.querySelector(".order-box.registered");

        function showOnly(box) {
          [firstTimeBox, guestBox, registeredBox].forEach((b) => {
            if (b) b.style.display = "none";
          });
          if (box) box.style.display = "block";
        }

        function formatDate(ts) {
          const dt = new Date(ts);
          return isNaN(dt.getTime())
            ? ""
            : dt.toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
              });
        }
        
        const toggleBtn = document.getElementById("toggleOrdersBtn");
          let showAllOrders = false;
          const PREVIEW_COUNT = 3; // number of recent orders shown initially
          let cachedOrders = [];

        /* ‚úÖ NEW: calculate total cost safely (uses saved total if you have it, otherwise sums items) */
        function computeOrderCost(order) {
          // common possible saved fields
          const direct =
            order.totalCost ??
            order.total ??
            order.orderTotal ??
            order.amount ??
            order.cost;

          const directNum = Number(direct);
          if (Number.isFinite(directNum) && directNum > 0) return directNum;

          // fallback: sum items (qty * price)
          const items = Array.isArray(order.items) ? order.items : [];
          let total = 0;

          for (const it of items) {
            const qty = Number(it.qty ?? it.quantity ?? 1) || 1;
            const price = Number(it.price ?? it.cost ?? it.unitPrice ?? 0) || 0;
            total += qty * price;
          }
          return total;
        }

        function renderOrders(ordersArray) {
          if (!orderList) return;

          // ‚úÖ sort newest -> oldest first
          cachedOrders = [...ordersArray].sort(
            (a, b) => (b.createdAt || 0) - (a.createdAt || 0)
          );

          // ‚úÖ then take the first few
          const displayOrders = showAllOrders
            ? cachedOrders
            : cachedOrders.slice(0, PREVIEW_COUNT);

          orderList.innerHTML = "";

          displayOrders.forEach((order) => {
            const li = document.createElement("li");

            let title = order.orderNo || "Order";
            if (Array.isArray(order.items) && order.items.length) {
              const first = order.items[0]?.item || order.items[0]?.name || "Order";
              const more = order.items.length - 1;
              title = more > 0 ? `${first} + ${more} more` : first;
            }

            const cost = computeOrderCost(order);

            li.innerHTML = `
              <div class="order-card">
                <span class="dish">üç≤ ${title}</span>
                <span class="order-right">
                  <span class="date">${formatDate(order.createdAt)}</span>
                  <span class="cost">$${Number(cost || 0).toFixed(2)}</span>
                </span>
              </div>
            `;

            orderList.appendChild(li);
          });

          toggleBtn?.addEventListener("click", () => {
            showAllOrders = !showAllOrders;
            renderOrders(cachedOrders);
          });


          // ‚úÖ button logic (DO NOT overwrite inner HTML)
          const toggleText = toggleBtn?.querySelector(".see-more-text");

          if (cachedOrders.length > PREVIEW_COUNT) {
            toggleBtn.style.display = "inline-flex";
            if (toggleText) {
              toggleText.textContent = showAllOrders
                ? "Show Less Orders"
                : "See More Orders";
            }
            toggleBtn.classList.toggle("expanded", showAllOrders);
          } else {
            toggleBtn.style.display = "none";
            toggleBtn.classList.remove("expanded");
          }
        }



        // ‚úÖ logged in user
        const username =
          sessionStorage.getItem("loggedInUser") ||
          localStorage.getItem("loggedInUser") ||
          "";
        let ownerKey = "";

        if (username) {
          ownerKey = username; // registered
        } else {
          // ‚úÖ guest orders were saved with guestId -> use the same key
          let guestId = localStorage.getItem("guestId");

          // if guestId doesn't exist (first time guest in this browser session)
          if (!guestId) {
            guestId = "guest_" + Math.random().toString(36).slice(2, 10);
            localStorage.setItem("guestId", guestId);
          }

          ownerKey = guestId;
        }

        // if still no key, show guest box
        if (!ownerKey) {
          showOnly(guestBox);
          return;
        }




        const qUserOrders = query(
          ref(db, "orders"),
          orderByChild("ownerKey"),
          equalTo(ownerKey)
        );

        onValue(
          qUserOrders,
          (snapshot) => {
            if (!snapshot.exists()) {
              if (!username) showOnly(guestBox); // guest but no orders
              else showOnly(firstTimeBox); // registered but no orders
              return;
            }

            showOnly(registeredBox);

            const data = snapshot.val(); // {pushId: orderObj, ...}
            const ordersArray = Object.entries(data).map(([id, order]) => ({
              id,
              ...order,
            }));

            renderOrders(ordersArray);
          },
          (err) => {
            console.error("Order history realtime error:", err);
            showOnly(firstTimeBox);
          }
        );

        // filter (still works)
        if (filterInput && orderList) {
          filterInput.addEventListener("keyup", () => {
            const q = filterInput.value.toLowerCase();
            Array.from(orderList.children).forEach((li) => {
              li.style.display = li.textContent.toLowerCase().includes(q) ? "" : "none";
            });
          });
        }
      });
    </script>
  </body>
</html>
