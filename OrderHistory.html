<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiokLah Dashboard</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&family=Open+Sans:wght@300..800&family=Roboto:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/jpeg" href="/images/ShiokLah(cropped).jpeg" />
    <link rel="stylesheet" href="Master_page_stylesheet.css" />
  <style>
      /* content */
      .order-box {
        max-width: 600px;
        margin: 40px auto;
        padding: 80px 60px;
        background: #fff8f0;
        border: 2px dashed #ff8c3a;
        border-radius: 18px;
        text-align: center;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
      }

      .order-box h2 {
        font-size: 28px;
        font-weight: 700;
        color: #ff7a18;
        margin-bottom: 12px;
        font-family: "Montserrat", sans-serif;
      }

      .order-box p {
        font-size: 16px;
        color: #444;
        margin-bottom: 24px;
        font-family: "Kodchasan", Arial;
      }

      .order-box a {
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        color: white;
      }
      .order-btn {
        display: inline-block;
        margin: 20px auto 0;
        background: #ff8c3a;
        color: #fff;
        text-decoration: none;
        padding: 12px 40px;
        font-size: 15px;
        font-weight: 700;
        border-radius: 999px;
        transition:
          background 0.3s ease,
          transform 0.2s ease; /* enables animation */
      }

      .order-btn:hover {
        background: #e6762f;
        transform: scale(1.05); /* hover animation */
      }

      .teaser {
        margin: 20px 0;
        text-align: center;
      }

      .teaser img {
        width: 120px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .teaser img:hover {
        transform: scale(1.05);
      }

      .teaser p {
        font-size: 14px;
        color: #555;
        margin-top: 8px;
        font-style: italic;
      }

      .filter-box {
        margin: 15px auto;
        max-width: 400px;
        text-align: center;
      }

      .filter-box input {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #ff8c3a;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .filter-box input:focus {
        border-color: #e6762f;
      }
      .order-list {
        list-style: none;
        padding: 0;
        margin: 20px auto;
        max-width: 500px;
      }

      .order-list li {
        margin-bottom: 12px;
      }

      .order-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .order-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
      }

      .order-card .dish {
        font-weight: 600;
        font-size: 15px;
        color: #333;
      }

      .order-card .date {
        font-size: 13px;
        color: #777;
        font-style: italic;
      }

      .menu-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .menu-card {
        width: 180px; /* fixed width */
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      .menu-card img {
        width: 100%; /* scales image to card width */
        height: 120px; /* fixed height */
        object-fit: cover; /* crop and fill nicely */
        border-radius: 8px;
      }

      .menu-card .name {
        margin-top: 8px;
        font-weight: 600;
      }

      .menu-card .price {
        margin-top: 4px;
        color: var(--primary-orange);
        font-weight: 700;
      }

      /* -------------------- MOBILE RESPONSIVE -------------------- */
      .hamburger {
        display: none;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
      }
      .hamburger div {
        width: 25px;
        height: 3px;
        background: #111;
        border-radius: 2px;
      }

      /* Extra small devices (phones < 576px) */
      @media (max-width: 576px) {
        .order-box {
          margin: 20px 10px;
          padding: 25px 15px;
        }
        .order-box h2 {
          font-size: 20px;
        }
        .order-box p {
          font-size: 13px;
        }
        .order-btn {
          padding: 10px 20px;
          font-size: 13px;
        }
        .teaser img {
          width: 80px;
        }
        .teaser p {
          font-size: 12px;
        }
        .order-list li {
          font-size: 13px;
          padding: 8px;
        }
        .hamburger {
          display: flex;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navrectangle">
      <div class="container">
        <div class="top-nav">
          <div class="nav-left">
            <div class="Logo">
              <img src="/images/ShiokLah(cropped).jpeg" alt="Logo" />
            </div>
          </div>

          <div class="nav-center">
            <ul class="menu" id="menu">
              <li class="menu-item">
                <a href="#">Home</a>
                <ul class="dropdown">
                  <li><a href="FED_ASG.html">Start Order</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Order History</a>
                <ul class="dropdown">
                  <li><a href="OrderHistory.html">Past Orders</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Profile</a>
                <ul class="dropdown">
                  <li><a href="UserProfile.html">Overview</a></li>
                  <li><a href="Analytics.html">Analytics & Reporting</a></li>
                  <li><a href="#">Customer Feedback</a></li>
                  <li><a href="#">Regulatory & Compliance</a></li>
                  <li><a href="#">Favourites</a></li>
                  <li><a href="#">Rewards</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="SelectRole.html">Log Out</a>
              </li>
            </ul>
          </div>

          <div class="nav-right">
            <button class="reserve-btn">Reserve A Table</button>
            <div class="hamburger" id="hamburger">
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <hr class="Nav-line" />

    <!-- MAIN -->
    <main class="main-content">
      <!-- FIRST TIME REGISTERED USER -->
      <div class="order-box first-time">
        <h2>üõí No orders yet</h2>
        <p>Place your first order to see it here.</p>

        <div class="teaser">
          <img src="images/Malay Cuisine Picture.jpg" alt="Teaser Dish" />
          <p>Try our bestselling Nasi Lemak today!</p>
        </div>

        <small class="tagline"
          >Your hawker favourites are just a click away!</small
        >
        <br />
        <a href="FED_ASG.html" class="order-btn">Start Ordering</a>
      </div>

      <!-- GUEST USER -->
      <div class="order-box guest">
        <h2>üë§ Guest User</h2>
        <p>
          You‚Äôre browsing as a guest. Sign up or log in to start ordering and
          track your history.
        </p>

        <div class="teaser">
          <img src="images/Chinese Cuisine Picture.jpg" alt="Guest Teaser" />
          <p>Join ShiokLah to unlock rewards!</p>
        </div>

        <small class="tagline"
          >Create an account to enjoy hawker favourites anytime.</small
        >
        <br />
        <a href="login.html" class="order-btn">Sign Up / Log In</a>
      </div>

      <!-- REGISTERED USER WITH MULTIPLE ORDERS -->
      <div class="order-box registered">
        <h2>üì¶ Your Order History</h2>
        <p>Here are your recent orders:</p>

        <!-- Filter Box -->
        <div class="filter-box">
          <input
            type="text"
            id="orderFilter"
            placeholder="Filter orders by dish or date..."
          />
        </div>

        <div id="menuList" class="menu-container"></div>

        <!-- Order History List -->
        <ul id="orderList" class="order-list">
          <!-- <li>
          <div class="order-card">
            <span class="dish">üç≤ Nasi Lemak</span>
            <span class="date">Jan 20, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">ü•ü Chicken Satay</span>
            <span class="date">Jan 25, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">üçú Laksa</span>
            <span class="date">Jan 28, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">üçõ Beef Rendang</span>
            <span class="date">Feb 2, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">ü•† Hainanese Chicken Rice</span>
            <span class="date">Feb 5, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">üç§ Char Kway Teow</span>
            <span class="date">Feb 10, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">ü•¨ Vegetarian Mee Goreng</span>
            <span class="date">Feb 12, 2026</span>
          </div>
        </li>
        <li>
          <div class="order-card">
            <span class="dish">üçπ Teh Tarik</span>
            <span class="date">Feb 15, 2026</span>
          </div>
        </li> -->
        </ul>

        <small class="tagline"
          >Keep enjoying your favourites ‚Äì we‚Äôll save them here!</small
        >
        <br />
        <a href="FED_ASG.html" class="order-btn">Order Again</a>
      </div>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
        push,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // ================= Firebase config =================
      const firebaseConfig = {
        apiKey: "AIzaSyCoYoGP4NYJPHqA-kV_swajQ4LSQYdyWV4",
        authDomain: "grp3fedapp.firebaseapp.com",
        databaseURL:
          "https://grp3fedapp-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grp3fedapp",
        storageBucket: "grp3fedapp.firebasestorage.app",
        messagingSenderId: "791146838729",
        appId: "1:791146838729:web:446baee191feeb036e2b18",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ‚úÖ Declare DOM + userId BEFORE using them
      // const userId = "user123"; // replace with auth.currentUser.uid later
      const userId = sessionStorage.getItem("currentUserId") || "guest";

      const orderList = document.getElementById("orderList");

      const firstTimeBox = document.querySelector(".order-box.first-time");
      const guestBox = document.querySelector(".order-box.guest");
      const registeredBox = document.querySelector(".order-box.registered");

      function showOnly(box) {
        [firstTimeBox, guestBox, registeredBox].forEach((b) => {
          if (b) b.style.display = "none";
        });
        if (box) box.style.display = "block";
      }

      function formatDate(d) {
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return "";
        return dt.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function orderTitle(order) {
        if (order.dish) return order.dish;

        if (Array.isArray(order.items) && order.items.length > 0) {
          const firstName = order.items[0]?.name || "Order";
          const more = order.items.length - 1;
          return more > 0 ? `${firstName} + ${more} more` : firstName;
        }

        return "Order";
      }

      // ‚úÖ REALTIME LISTENER (read-only)
      function renderOrdersRealtime(uid) {
        const ordersRef = ref(db, `orders/${uid}`);

        onValue(
          ordersRef,
          (snapshot) => {
            orderList.innerHTML = "";

            if (!snapshot.exists()) {
              showOnly(firstTimeBox);
              return;
            }

            showOnly(registeredBox);

            const ordersObj = snapshot.val();
            const ordersArray = Object.entries(ordersObj).map(([id, data]) => ({
              id,
              ...data,
            }));

            ordersArray.sort((a, b) => new Date(b.date) - new Date(a.date));

            ordersArray.forEach((order) => {
              const li = document.createElement("li");
              li.innerHTML = `
                <div class="order-card">
                  <span class="dish">üç≤ ${orderTitle(order)}</span>
                  <span class="date">${formatDate(order.date)}</span>
                </div>
              `;
              orderList.appendChild(li);
            });
          },
          (error) => {
            console.error("Realtime order listener error:", error);
            showOnly(firstTimeBox);
          }
        );
      }

      renderOrdersRealtime(userId);

      // ================= TEST ONLY (writes 1 order) =================
      // Set this to true ONCE to test, then set back to false.
      const RUN_SEED_TEST = false;

      async function seedTestOrder() {
        try {
          const ordersRef = ref(db, `orders/${userId}`);
          const testOrderRef = push(ordersRef);

          await set(testOrderRef, {
            stall: "Banana Leaf Nasi Lemak",
            items: [
              { name: "Set Meal A", qty: 1, price: 5 },
              { name: "1 Pcs Spicy Fish Otah", qty: 2, price: 1.5 },
            ],
            total: 8,
            date: new Date().toISOString(),
          });

          console.log("‚úÖ Test order written to:", `orders/${userId}`);
        } catch (e) {
          console.error("‚ùå seedTestOrder failed:", e);
          alert("seedTestOrder failed ‚Äî check Console for error (likely permissions).");
        }
      }

      if (RUN_SEED_TEST) seedTestOrder();


      // ================= NAVIGATION DROPDOWN =================
      document.querySelectorAll(".menu-item").forEach((item) => {
        const mainLink = item.querySelector("a");
        const dropdown = item.querySelector(".dropdown");
        if (!dropdown) return;

        mainLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          document.querySelectorAll(".menu-item").forEach((i) => {
            if (i !== item) i.classList.remove("active");
          });
          item.classList.toggle("active");
        });
      });

      document.addEventListener("click", () => {
        document
          .querySelectorAll(".menu-item")
          .forEach((item) => item.classList.remove("active"));
      });

      // Hamburger toggle
      const hamburger = document.getElementById("hamburger");
      const menu = document.getElementById("menu");
      hamburger.addEventListener("click", () => menu.classList.toggle("show"));

      document.querySelectorAll(".menu-item > a").forEach((link) => {
        link.addEventListener("click", (e) => {
          const dropdown = link.nextElementSibling;
          if (dropdown && window.innerWidth <= 768) {
            e.preventDefault();
            dropdown.classList.toggle("show");
          }
        });
      });

      
      // ================= FILTER ORDERS =================
      const filterInput = document.getElementById("orderFilter");
      const orderLists = document.getElementById("orderList");

      filterInput.addEventListener("keyup", function () {
        const filterValue = filterInput.value.toLowerCase();
        Array.from(orderLists.children).forEach((li) => {
          li.style.display = li.textContent.toLowerCase().includes(filterValue)
            ? ""
            : "none";
        });
      });

      // ================= FIREBASE ORDERS (Realtime DB) =================
      //const userId = "user123"; // replace with auth.currentUser.uid after login

      async function loadOrders(userId) {
        try {
          const ordersRef = ref(db, `orders/${userId}`); // path: /orders/user123
          const snapshot = await get(ordersRef);
          orderList.innerHTML = "";

          if (snapshot.exists()) {
            const orders = snapshot.val(); // orders is an object
            // Convert object to array sorted by date descending
            const ordersArray = Object.values(orders).sort(
              (a, b) => new Date(b.date) - new Date(a.date),
            );

            ordersArray.forEach((order) => {
              const li = document.createElement("li");
              li.innerHTML = `
              <div class="order-card">
                <span class="dish">${order.dish}</span>
                <span class="date">${new Date(order.date).toLocaleDateString()}</span>
              </div>`;
              orderList.appendChild(li);
            });
          } else {
            console.log("No orders found for user:", userId);
          }
        } catch (error) {
          console.error("Error loading orders:", error);
        }
      }

      loadOrders(userId);
    </script>
  </body>
</html>
