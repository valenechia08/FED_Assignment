<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ShiokLah! Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="Master_page_stylesheet.css" />

    <style>
      

      /* ==========================
         DASHBOARD (CONTENT ONLY)
      ========================== */
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --stroke: #e9eef6;
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
        --radius: 16px;
        --text: #0f172a;
        --muted: #64748b;
      }

      .dash-wrap {
        width: 90%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px 0 40px;
        font-family:"Kodchasan",Arial, Helvetica, sans-serif;
      }

      .dash-wrap .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 14px;
        margin-bottom: 18px;
      }

      .dash-wrap .kpi-card {
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 14px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        min-width: 0;
      }

      .dash-wrap .kpi-left { min-width: 0; }

      .dash-wrap .kpi-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .dash-wrap .kpi-value {
        font-size: 22px;
        font-weight: 800;
        letter-spacing: -0.2px;
        line-height: 1.1;
      }

      .dash-wrap .kpi-sub {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }

      .dash-wrap .kpi-badge {
        flex: 0 0 auto;
        padding: 8px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 800;
        border: 1px solid var(--stroke);
        background: #f8fafc;
        color: #0f172a;
        white-space: nowrap;
      }

      .dash-wrap .kpi-badge.up {
        background: rgba(34, 197, 94, 0.12);
        border-color: rgba(34, 197, 94, 0.25);
        color: #166534;
      }

      .dash-wrap .kpi-badge.down {
        background: rgba(239, 68, 68, 0.12);
        border-color: rgba(239, 68, 68, 0.25);
        color: #7f1d1d;
      }

      .dash-wrap .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
        align-items: stretch;
      }

      .dash-wrap .full-width { grid-column: 1 / -1; }

      .dash-wrap section {
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px 18px 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 0;
      }

      .dash-wrap section h2 { margin: 0; font-size: 18px; letter-spacing: -0.2px; }

      .dash-wrap .card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .dash-wrap .card-tools { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

      .dash-wrap label { font-weight: 700; color: var(--muted); font-size: 13px; }

      .dash-wrap select {
        height: 34px;
        padding: 0 12px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: #fff;
        font-family: "Kodchasan",Arial, Helvetica, sans-serif;
        font-weight: 600;
        color: var(--text);
        outline: none;
      }

      .dash-wrap select:focus {
        border-color: rgba(255, 140, 58, 0.45);
        box-shadow: 0 0 0 4px rgba(255, 140, 58, 0.12);
      }

      .dash-wrap .card-divider { height: 1px; width: 100%; background: var(--stroke); }

      .dash-wrap .insight {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        font-size: 12px;
        color: var(--muted);
        font-weight: 700;
      }
      .dash-wrap .insight strong { color: var(--text); }

      .dash-wrap .chart-box {
        position: relative;
        width: 100%;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dash-wrap .chart-box--large { height: 380px; }

      .dash-wrap .chart-box--donut { display: flex; justify-content: center; align-items: center; }
      .dash-wrap .donut-wrapper { height: 100%; aspect-ratio: 1 / 1; max-width: 320px; }

      .dash-wrap .chart-box--donut canvas { width: 100%; height: 100%; }
      .dash-wrap .chart-box canvas { width: 100%; height: 100%; }

      @media (max-width: 980px) {
        .dash-wrap .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      @media (max-width: 900px) {
        .dash-wrap select {
          font-size: 12px;
          height: 30px;
        }

        .dash-wrap select option {
          font-size: 11px;        /* ðŸ‘ˆ even smaller on mobile */
          padding: 5px 8px;
        }
        .dash-wrap .grid { grid-template-columns: 1fr; }
        .dash-wrap .chart-box { height: 260px; }
        .dash-wrap .chart-box--large { height: 320px; }
      }
      @media (max-width: 520px) {
        .dash-wrap .kpi-grid { grid-template-columns: 1fr; }

        /* Stack title + filter nicely */
        .dash-wrap .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        /* Smaller dropdown text (menu + selected) */
        /* .dash-wrap select,
        .dash-wrap select option {
          font-size: 12px;
        } */

        /* Optional: keep filter from being huge */
        /* .dash-wrap select { height: 30px; padding: 0 10px; }
      } */
      }
    </style>
  </head>

  <body>
    <nav class="navrectangle">
      <div class="container">
        <div class="top-nav">
          <div class="nav-left">
            <div class="Logo">
              <img src="images/ShiokLah(cropped).jpeg" alt="Logo" />
            </div>
          </div>

          <div class="nav-center">
            <ul class="menu" id="menu">
              <li class="menu-item">
                <a href="#">Home</a>
                <ul class="dropdown">
                  <li><a href="FED_ASG.html">Start Order</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Order History</a>
                <ul class="dropdown">
                  <li><a href="OrderHistory.html">Past Orders</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="#">Profile</a>
                <ul class="dropdown">
                  <li><a href="UserProfile.html">Overview</a></li>
                  <li><a href="Analytics.html">Analytics & Reporting</a></li>
                  <li><a href="#">Customer Feedback</a></li>
                  <li><a href="#">Regulatory & Compliance</a></li>
                  <li><a href="#">Favourites</a></li>
                  <li><a href="#">Rewards</a></li>
                </ul>
              </li>

              <li class="menu-item">
                <a href="SelectRole.html">Log Out</a>
              </li>
            </ul>
          </div>

          <div class="nav-right">
            <button class="reserve-btn">Reserve A Table</button>
            <div class="hamburger" id="hamburger">
              <div></div><div></div><div></div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="nav-overlay" id="navOverlay"></div>
    <hr class="Nav-line" />

    <div class="dash-wrap">
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-left">
            <div class="kpi-title">Total Orders</div>
            <div class="kpi-value" id="kpiTotalOrders">â€”</div>
            <div class="kpi-sub" id="kpiOrdersSub">This Month</div>
          </div>
          <div class="kpi-badge up" id="kpiOrdersDelta">+0%</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-left">
            <div class="kpi-title">Top Item</div>
            <div class="kpi-value" id="kpiTopItem">â€”</div>
            <div class="kpi-sub" id="kpiTopItemSub">Share: â€”</div>
          </div>
          <div class="kpi-badge" id="kpiTopItemBadge">Hot</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-left">
            <div class="kpi-title">Avg Rating</div>
            <div class="kpi-value" id="kpiAvgRating">â€”</div>
            <div class="kpi-sub" id="kpiRatingSub">From feedback mix</div>
          </div>
          <div class="kpi-badge" id="kpiRatingBadge">Stable</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-left">
            <div class="kpi-title">Inspection Score</div>
            <div class="kpi-value" id="kpiInspectScore">â€”</div>
            <div class="kpi-sub" id="kpiInspectSub">Latest period</div>
          </div>
          <div class="kpi-badge up" id="kpiInspectDelta">â€”</div>
        </div>
      </div>

      <div class="grid">
        <section>
          <div class="card-header">
            <h2>Sales Analytics</h2>
            <div class="card-tools">
              <label for="salesFilter">Filter</label>
              <select id="salesFilter">
                <option value="month">This Month</option>
                <option value="3months">Last 3 Months</option>
                <option value="6months">Last 6 Months</option>
              </select>
            </div>
          </div>

          <div class="insight">
            <span id="salesInsightText">â€”</span>
            <span><strong id="salesInsightStrong">â€”</strong></span>
          </div>

          <div class="card-divider"></div>

          <div class="chart-box">
            <canvas id="salesChart"></canvas>
          </div>
        </section>

        <section>
          <div class="card-header">
            <h2>Customer Feedback</h2>
            <div class="card-tools">
              <label for="feedbackFilter">Filter by</label>
              <select id="feedbackFilter">
                <option value="month">This Month</option>
                <option value="3months">Last 3 Months</option>
                <option value="6months">Last 6 Months</option>
              </select>
            </div>
          </div>

          <div class="insight">
            <span id="feedbackInsightText">â€”</span>
            <span><strong id="feedbackInsightStrong">â€”</strong></span>
          </div>

          <div class="card-divider"></div>

          <div class="chart-box chart-box--donut">
            <div class="donut-wrapper">
              <canvas id="feedbackChart"></canvas>
            </div>
          </div>
        </section>

        <section class="full-width">
          <div class="card-header">
            <h2>Hygiene & Inspections</h2>
            <div class="card-tools">
              <label for="hygieneFilter">Year</label>
              <select id="hygieneFilter">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
              </select>
            </div>
          </div>

          <div class="insight">
            <span id="hygieneInsightText">â€”</span>
            <span><strong id="hygieneInsightStrong">â€”</strong></span>
          </div>

          <div class="card-divider"></div>

          <div class="chart-box chart-box--large">
            <canvas id="hygieneChart"></canvas>
          </div>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="Master_page_javascript.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        query,
        orderByChild,
        equalTo
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCoYoGP4NYJPHqA-kV_swajQ4LSQYdyWV4",
        authDomain: "grp3fedapp.firebaseapp.com",
        databaseURL: "https://grp3fedapp-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grp3fedapp",
        storageBucket: "grp3fedapp.firebasestorage.app",
        messagingSenderId: "791146838729",
        appId: "1:791146838729:web:446baee191feeb036e2b18",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ------- helpers -------
      const sum = (arr) => arr.reduce((a, b) => a + b, 0);
      const maxIndex = (arr) => {
        let idx = 0;
        for (let i = 1; i < arr.length; i++) if (arr[i] > arr[idx]) idx = i;
        return idx;
      };
      const percentChange = (cur, prev) => (prev === 0 ? 0 : ((cur - prev) / prev) * 100);
      const fmtPct = (n) => `${n >= 0 ? "+" : ""}${n.toFixed(1)}%`;

      function setDelta(el, value) {
        if (!el) return;
        el.textContent = fmtPct(value);
        el.classList.remove("up", "down");
        el.classList.add(value >= 0 ? "up" : "down");
      }

      function getOwnerKey() {
        const username =
          sessionStorage.getItem("loggedInUser") ||
          localStorage.getItem("loggedInUser") ||
          "";

        return username ? username : (localStorage.getItem("guestId") || "");
      }

      // --- time windows ---
      function windowStartMs(filter) {
        const now = Date.now();
        const day = 24 * 60 * 60 * 1000;

        if (filter === "month") return now - 30 * day;
        if (filter === "3months") return now - 90 * day;
        if (filter === "6months") return now - 180 * day;

        return now - 30 * day;
      }

      function previousWindowStartMs(filter) {
        const now = Date.now();
        const day = 24 * 60 * 60 * 1000;

        // previous period of same length
        if (filter === "month") return now - 60 * day;     // previous 30 days
        if (filter === "3months") return now - 180 * day;  // previous 90 days
        if (filter === "6months") return now - 360 * day;  // previous 180 days

        return now - 60 * day;
      }

      function ordersInRange(orders, startMs, endMs) {
        return orders.filter(o => (o.createdAt || 0) >= startMs && (o.createdAt || 0) < endMs);
      }

      // --- aggregate: top items by qty ---
      function computeTopItems(orders, topN = 3) {
        const counts = new Map();

        orders.forEach(order => {
          const items = Array.isArray(order.items) ? order.items : [];
          items.forEach(it => {
            const name = it.item || it.name || "Unknown";
            const qty = Number(it.qty || 1);
            counts.set(name, (counts.get(name) || 0) + qty);
          });
        });

        const sorted = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]);
        const top = sorted.slice(0, topN);

        return {
          labels: top.map(x => x[0]),
          data: top.map(x => x[1]),
          all: sorted
        };
      }

      // ------- Chart init (same style as yours) -------
      const salesCanvas = document.getElementById("salesChart");
      const salesChart = new Chart(salesCanvas, {
        type: "bar",
        data: { labels: [], datasets: [{ label: "Orders", data: [] }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: "rgba(15,23,42,0.06)" }, ticks: { precision: 0 } },
          },
        },
      });

      // ------- MAIN realtime listener -------
      const ownerKey = getOwnerKey();
      if (!ownerKey) {
        // no user/guest -> show 0s
        document.getElementById("kpiTotalOrders").textContent = "0";
      } else {
        const qUserOrders = query(ref(db, "orders"), orderByChild("ownerKey"), equalTo(ownerKey));

        onValue(qUserOrders, (snapshot) => {
          const data = snapshot.exists() ? snapshot.val() : {};
          const orders = Object.entries(data).map(([id, order]) => ({ id, ...order }));

          // update everything whenever Firebase changes
          renderSalesAndKPI(orders);
        });
      }

      // also react when user changes the dropdown filter
      document.getElementById("salesFilter")?.addEventListener("change", () => {
        const ownerKey = getOwnerKey();
        if (!ownerKey) return;

        const qUserOrders = query(ref(db, "orders"), orderByChild("ownerKey"), equalTo(ownerKey));
        // we already have the onValue listener; simplest is to just recompute from last snapshot
        // (so we keep a cached copy)
        // We'll store in window for convenience:
        renderSalesAndKPI(window.__ordersCache || []);
      });

      function renderSalesAndKPI(orders) {
        window.__ordersCache = orders;

        const filter = document.getElementById("salesFilter")?.value || "month";
        const now = Date.now();

        const startNow = windowStartMs(filter);
        const startPrev = previousWindowStartMs(filter);

        const current = ordersInRange(orders, startNow, now);
        const previous = ordersInRange(orders, startPrev, startNow);

        // KPI: total orders (current window)
        const totalOrdersNow = current.length;
        const totalOrdersPrev = previous.length;
        const delta = percentChange(totalOrdersNow, totalOrdersPrev);

        document.getElementById("kpiTotalOrders").textContent = String(totalOrdersNow);
        document.getElementById("kpiOrdersSub").textContent =
          filter === "month" ? "Last 30 days" : filter === "3months" ? "Last 90 days" : "Last 180 days";
        setDelta(document.getElementById("kpiOrdersDelta"), delta);

        // Sales chart: top items by qty (current window)
        const top = computeTopItems(current, 3);

        salesChart.data.labels = top.labels;
        salesChart.data.datasets[0].data = top.data;
        salesChart.update();

        // Insight text under Sales Analytics
        const totalItems = sum(top.data);
        if (top.labels.length) {
          const idx = maxIndex(top.data);
          const topName = top.labels[idx];
          const topVal = top.data[idx];
          const share = totalItems ? (topVal / totalItems) * 100 : 0;

          document.getElementById("kpiTopItem").textContent = topName;
          document.getElementById("kpiTopItemSub").textContent = `Share: ${share.toFixed(1)}%`;
          document.getElementById("kpiTopItemBadge").textContent = share >= 45 ? "Hot" : "Steady";

          document.getElementById("salesInsightText").textContent = `Top seller is ${topName} with`;
          document.getElementById("salesInsightStrong").textContent = `${topVal} items (${share.toFixed(1)}%)`;
        } else {
          document.getElementById("kpiTopItem").textContent = "â€”";
          document.getElementById("kpiTopItemSub").textContent = "Share: â€”";
          document.getElementById("kpiTopItemBadge").textContent = "â€”";
          document.getElementById("salesInsightText").textContent = "No orders in this period.";
          document.getElementById("salesInsightStrong").textContent = "â€”";
        }
      }
    </script>

  </body>
</html>
