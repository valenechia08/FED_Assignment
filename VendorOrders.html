<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiokLah!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="Vendor.css" />
    <style>
      :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#eceff5;
      --shadow:0 10px 28px rgba(16,24,40,.10);
      --green:#039855;
      --green-bg:#e8f8ef;
      --red:#d92d20;
      --red-bg:#ffe7ea;
      --radius:14px;
    }
    .wrap{
      max-width: 1100px;
      margin: auto;
      margin-top:15px;
    }
      .orders-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        padding: 0 10px;
      }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background-color: #ffdfae;
    }

    .card-title{
      font-size:20px;
      margin-left:10px;
      margin-top:10px;
      margin-bottom:10px;
      font-weight:700;
      color:#344054;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    /* FILTER DROPDOWN */
    select{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
    }

    /* ADD BUTTON */
    .add-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:none;
      background:#ff8c3a;
      color:white;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
    }

    .list{display:flex;flex-direction:column;}

    .row{
      display:flex;
      align-items:center;
      gap:18px;
      padding:22px 26px;
      border-radius:10px;
      border-bottom:2px solid var(--line);
      cursor:pointer;
    }
    /* alternating order row colours */
    .row:nth-child(odd) {
      background: #ffeadc;
    }

.row:nth-child(even) {
  background: #fef7f3;
}

    .row:last-child{border-bottom:none;}
    .row:hover{background:#ffe6d3;}

    .icon{
      border-radius:12px;
      display:grid;
      place-items:center;
      font-size: 40px;
      margin-bottom:10px;
    }
    .drawer-actions{
  margin-top: 10px;
  display:flex;
  justify-content:flex-end;
  gap: 12px;              /* ‚úÖ gap between buttons */
  flex-wrap: wrap;
}

.btn-lite{
  height: 42px;
  padding: 0 16px;
  border-radius: 12px;
}

    .main{
      flex:1;
      min-width:0;
    }

    .top{
      display:flex;
      gap:10px;
      align-items:baseline;
    }

    .aid{
  font-size: 15px;
  font-weight: 700;
}

    .address{
      font-size:15px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sub{
      margin-top:8px;
      font-size:14px;
      color:var(--text);
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      font-size:13px;
      padding: 7px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }

    .badge.active{background:var(--green-bg);color:var(--green);border:2px solid var(--green)}
    .expired{background:var(--red-bg);color:var(--red);border:1.5px solid var(--red)}
    .badge.pending{
  background: #fffab1;
  color: #d79e00;
  border: 1.5px solid rgba(181,71,8,.25);
}


    .arrow-btn{
    background: none;
    border: none;
    font-size: 20px;
    font-weight: 700;
    color: #98a2b3;
    cursor: pointer;
    padding: 4px 6px;
    line-height: 1;
    transition: transform .15s ease, color .15s ease;
  }

  .arrow-btn:hover{
    font-size: 22px;
    color: #475467;
    transform: translateX(3px);
}

.end-date{
  font-weight: 700;
}
/* drawer styles */
  .drawer { position: fixed; inset: 0; display: none; z-index: 2000; }
  .drawer.show { display: block; }
  .drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
  .drawer-panel {
    position: absolute; top: 0; right: 0;
    height: 100%; width: min(420px, 92vw);
    background: #fff;
    box-shadow: -20px 0 40px rgba(0,0,0,.18);
    display: flex; flex-direction: column;
  }
  .drawer-head{
    padding: 14px 16px;
    border-bottom: 1px solid var(--line);
    display:flex; align-items:center; justify-content: space-between;
    background: #ffdfae;
  }
  .drawer-title{ font-weight: 900; color:#344054; font-size: 16px; }
  .drawer-close{
    width: 34px; height: 34px; border-radius: 10px;
    border: 1px solid var(--line);
    background: #fff; cursor: pointer; font-weight: 900;
  }
  .drawer-body{ padding: 16px; overflow:auto; display:grid; gap: 10px; }
  .drow{ display:flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px dashed var(--line); }
  .dk{ color: var(--muted); font-weight: 800; font-size: 12.5px; }
  .dv{ color: var(--text); font-weight: 900; font-size: 13.5px; text-align:right; word-break: break-word; }
  .dnotes{ margin-top: 8px; border: 1px solid var(--line); border-radius: 12px; padding: 12px; background:#fafbff; }
  .dnotes-title{ font-weight: 900; color:#344054; margin-bottom: 8px; }
  .dnotes-body{ color: var(--text); font-weight: 600; white-space: pre-wrap; line-height: 1.4; }
  .drawer-actions{ margin-top: 6px; display:flex; justify-content:flex-end; }
  .btn-lite{
    height: 40px; padding: 0 14px; border-radius: 12px;
    border: none; background:#ff8c3a; color:#fff; font-weight: 900; cursor:pointer;
  }
  .btn-accept {
  background: #039855;
  color: #fff;
}

.btn-complete {
  background: #1a73e8;
  color: #fff;
}

.btn-cancel {
  background: #d92d20;
  color: #fff;
}

.btn-ghost {
  background: #fff;
  border: 1px solid var(--line);
  color: #344054;
}


  /* small improvement for row click: only arrow opens drawer */
  .row { cursor: default; }
  .arrow-btn { cursor: pointer; }

/* timer beside order id */
.timer{
  font-size: 16px;        /* If timer <=15 */
  font-weight: 900;
  margin-left: 10px;
  color: #344054;
}

.timer.overdue{
  color: #d92d20;         /* If timer> 15 mins */
}


/* order status badges */
.badge.pending {
  background: #fffab1;
  color: #d79e00;
  border: 1.5px solid rgba(215,158,0,.35);
}

.badge.progress {
  background: #e8f1ff;
  color: #1a73e8;
  border: 1.5px solid rgba(26,115,232,.25);
}

.badge.completed {
  background: #e8f8ef;
  color: #039855;
  border: 1.5px solid rgba(3,152,85,.25);
}

.badge.cancelled {
  background: #ffe7ea;
  color: #d92d20;
  border: 1.5px solid rgba(217,45,32,.25);
}
.email {
  font-size: 13px;
  color: var(--muted);
  font-weight: 700;
}

.subline {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.subline b { font-weight: 900; }

    </style>
  </head>
  <body>
    <!-- Vendor Home -->
     <section class="container vendornav">
      <nav class="navrectangle">
        <header class="brand">
          <img src="images/ShiokLahTransparent.png" alt="ShiokLah">
        </header>

       <ul class="navBar">
        <li class="main toggle" data-link="PerformanceDashboard.html">
          <div class="title-row"><img src="images/statisctics.png" data-default="images/statisctics.png"
      data-active="images/orangestatisctics.png" alt="ShiokLah">Dashboard</div>
        </li>
        
        <li class="main toggle" data-link="VendorEditMenu.html">
          <div class="title-row"><img src="images/menu (2).png" data-default="images/menu (2).png"
      data-active="images/orangemenu.png" alt="ShiokLah">Edit Menu</div>
      </li>

        <li class="main toggle">
          <div class="title-row"><img src="images/user.png" data-default="images/user.png"
      data-active="images/orangeuser.png" alt="ShiokLah">Profile <span class="arrow"><img src="images/down.png" ></span></div>
          <ul class="submenu">
            <li><button class="subpoint" data-link="StallHygieneGrades.html">‚Ä¢ Hygiene History</button></li>
            <li><button class="subpoint" data-link="VendorOrders.html">‚Ä¢ Orders</button></li>
            <li><button class="subpoint" data-link="RentalAgreement.html">‚Ä¢ Rental Agreements</button></li>
            <li><button class="subpoint" data-link="CustomerFeedback.html">‚Ä¢ Customer Feedback</button></li>
            <li><button class="subpoint">‚Ä¢ Settings</button></li>
          </ul>
        </li>

        <li class="main toggle logout">
          <button onclick="window.location.href='login.html'" class="subpoint"><img src="images/logout.png" data-default="images/logout.png"
      data-active="images/orangelogout.png" alt="ShiokLah">Log Out</button>
        </li>
      </ul>

    </nav>

      <nav class="mobile-nav vendornav">
        <div class="mobile-nav-item active" data-link="FED_ASG.html">
          <span>üè†</span>
          <small>Home</small>
        </div>

        <div class="mobile-nav-item" data-link="VendorEditMenu.html">
          <span>üçΩÔ∏è</span>
          <small>Edit Menu</small>
        </div>

        <div class="mobile-nav-item" data-link="VendorProfile.html">
          <span>üë§</span>
          <small>Profile</small>
        </div>
      </nav>

  <main class="contents">

    <div class="orders-head">
  <div class="card-title">Incoming Orders</div>

  <div class="header-actions">
    <select id="statusFilter">
      <option value="all">All Status</option>
      <option value="pending">Pending</option>
      <option value="in progress">In Progress</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
  </div>
</div>


    <div class="list" id="orderList"></div>
        <!-- rows will be rendered here -->
   <!-- RIGHT DRAWER (view more) -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer-panel">
      <div class="drawer-head">
        <div class="drawer-title" id="dTitle">Order</div><!-- remove the End Date row completely -->
        <button class="drawer-close" id="drawerClose" type="button">‚úï</button>
      </div>

      <div class="drawer-body">
        <div class="drow"><div class="dk">Order No.</div><div class="dv" id="dAID">‚Äî</div></div>
        <div class="drow"><div class="dk">Ordered by</div><div class="dv" id="dLoc">‚Äî</div></div>
        <div class="drow"><div class="dk">Email</div><div class="dv" id="dAddr">‚Äî</div></div>
        <div class="drow"><div class="dk">Payment Method</div><div class="dv" id="dTrade">‚Äî</div></div>
        <div class="drow"><div class="dk">Total</div><div class="dv" id="dRent">‚Äî</div></div>
        <div class="drow"><div class="dk">Date of Order</div><div class="dv" id="dStart">‚Äî</div></div>
        <div class="drow"><div class="dk">Status</div><div class="dv" id="dStatus">‚Äî</div></div>

        <div class="dnotes">
          <div class="dnotes-title" id="dNoteTitle">Notes</div>
          <div class="dnotes-body" id="dNotes">‚Äî</div>
        </div>

        <div class="drawer-actions" id="drawerActions"></div>

      </div>
    </div>
  </aside>
</main>
  </section>
  <script>
      const current = location.pathname.split("/").pop(); // e.g. VendorOrders.html

document.querySelectorAll(".main[data-link]").forEach(main => {
  if (main.dataset.link === current) {
    main.classList.add("active");
    const icon = main.querySelector(".title-row img");
    if (icon?.dataset?.active) icon.src = icon.dataset.active;
  }
});


  // Helper: get icon for a main item (normal or logout)
  function getMainIcon(main) {
    return main.querySelector(".title-row img") || main.querySelector(".subpoint img");
  }

  // Reset all active states (except optional keep param)
  function resetAllActive(keepMain = null) {
    document.querySelectorAll(".main").forEach(m => {
      if (m !== keepMain) m.classList.remove("active");

      const ic = getMainIcon(m);
      if (ic && ic.dataset.default) ic.src = ic.dataset.default;

      // close any submenu
      const sm = m.querySelector(".submenu");
      if (sm) sm.style.display = "none";
    });
  }

  // MAIN NAV LOGIC
  document.querySelectorAll(".main").forEach(main => {
    const icon = getMainIcon(main);

    // Hover icon change (only if not active)
    if (icon && icon.dataset.active) {
      main.addEventListener("mouseenter", () => {
        if (!main.classList.contains("active")) icon.src = icon.dataset.active;
      });

      main.addEventListener("mouseleave", () => {
        if (!main.classList.contains("active")) icon.src = icon.dataset.default;
      });
    }

    const titleRow = main.querySelector(".title-row");
    const submenu = main.querySelector(".submenu");

    // If it has submenu (Profile), clicking title toggles open/close
    if (submenu && titleRow) {
      titleRow.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = main.classList.contains("active");

        // close others first
        resetAllActive(main);

        // toggle this one
        if (isOpen) {
          main.classList.remove("active");
          submenu.style.display = "none";
          if (icon && icon.dataset.default) icon.src = icon.dataset.default;
        } else {
          main.classList.add("active");
          submenu.style.display = "block";
          if (icon && icon.dataset.active) icon.src = icon.dataset.active;
        }
      });

      return; // IMPORTANT: don't attach redirect to Profile main item
    }

    // If it's a normal clickable page (Dashboard/Edit Menu)
    const link = main.dataset.link;
    if (link) {
      main.addEventListener("click", () => {
        resetAllActive(main);
        main.classList.add("active");
        if (icon && icon.dataset.active) icon.src = icon.dataset.active;
        window.location.href = link;
      });
    }
  });

  // SUBMENU BUTTON REDIRECTS
  document.querySelectorAll(".subpoint[data-link]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = btn.dataset.link;
    });
  });

  // ARROW IMAGE HOVER (only where arrow exists)
  document.querySelectorAll(".title-row").forEach(row => {
    const arrowImg = row.querySelector(".arrow img");
    if (!arrowImg) return;

    row.addEventListener("mouseenter", () => {
      arrowImg.src = "images/orangedown.png";
    });
    row.addEventListener("mouseleave", () => {
      arrowImg.src = "images/down.png";
    });
  });

  // Optional: click outside to close dropdown
  document.addEventListener("click", () => {
    resetAllActive(null);
  });
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, get,update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoYoGP4NYJPHqA-kV_swajQ4LSQYdyWV4",
    authDomain: "grp3fedapp.firebaseapp.com",
    databaseURL: "https://grp3fedapp-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "grp3fedapp",
    storageBucket: "grp3fedapp.firebasestorage.app",
    messagingSenderId: "791146838729",
    appId: "1:791146838729:web:446baee191feeb036e2b18",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const $ = (id) => document.getElementById(id);

  const STALL_NAME = "Banana Leaf Nasi Lemak";

  const listEl = $("orderList");
  const filterEl = $("statusFilter");

  // drawer elements (re-using your existing IDs)
  const drawer = $("drawer");
  const overlay = $("drawerOverlay");
  const closeBtn = $("drawerClose");

  // cache email lookups (so we don't spam Firebase)
  const emailCache = new Map();
  function normalizeItems(items) {
  if (!items) return [];

  if (Array.isArray(items)) return items;

  // Firebase object ‚Üí array
  if (typeof items === "object") {
    return Object.entries(items).map(([key, value]) => ({
      item: key,
      ...value,
    }));
  }

  return [];
}

  function normalizeStatus(s) {
    const v = String(s || "Pending").toLowerCase().trim();
    if (v === "pending") return "pending";
    if (v === "in progress" || v === "inprogress" || v === "accepted") return "in progress";
    if (v === "completed" || v === "done") return "completed";
    if (v === "cancelled" || v === "canceled" || v === "declined") return "cancelled";
    return "pending";
  }

  function badgeHTML(status) {
    const st = normalizeStatus(status);
    if (st === "pending") return `<span class="badge pending">Pending</span>`;
    if (st === "in progress") return `<span class="badge active">In Progress</span>`;
    if (st === "completed") return `<span class="badge active">Completed</span>`;
    return `<span class="badge expired">Cancelled</span>`;
  }

  function formatTime(ms) {
    const d = new Date(ms);
    if (isNaN(d)) return "‚Äî";
    return d.toLocaleString("en-SG", {
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  // item field mapping (defensive)
  function getStall(it) {
    return it?.stallName || it?.stall || it?.vendor || it?.restaurantName || "";
  }
 function getItemName(it) {
  // Case 1: item name is stored as a string value
  if (typeof it?.item === "string") return it.item;

  // Case 2: common alternative field names
  if (typeof it?.menuItem === "string") return it.menuItem;
  if (typeof it?.itemName === "string") return it.itemName;
  if (typeof it?.name === "string") return it.name;
  if (typeof it?.displayName === "string") return it.displayName;

  // Case 3: item name is the KEY itself (Firebase object-style)
  if (it && typeof it === "object") {
    const keys = Object.keys(it);
    if (keys.length === 1) return keys[0];
  }

  return "Item";
}

  function getQty(it) {
    return Number(it?.qty ?? it?.quantity ?? it?.count ?? 1) || 1;
  }
  function getPrice(it) {
    return Number(it?.price ?? it?.unitPrice ?? it?.cost ?? 0) || 0;
  }

  function subtotalForItems(items) {
    return items.reduce((sum, it) => sum + getQty(it) * getPrice(it), 0);
  }

  // try to get customer email:
  // 1) if order.email exists use it
  // 2) else try /members/{username}/email (common pattern)
  async function getCustomerEmail(order) {
    if (order?.email) return String(order.email);

    const username = (order?.username || "").trim();
    if (!username) return "‚Äî";

    if (emailCache.has(username)) return emailCache.get(username);

    try {
      const snap = await get(ref(db, `members/${username}/email`));
      const email = snap.exists() ? String(snap.val()) : "‚Äî";
      emailCache.set(username, email);
      return email;
    } catch {
      emailCache.set(username, "‚Äî");
      return "‚Äî";
    }
  }
function getOrderMode(o) {
  return o?.orderMode || o?.orderType || o?.mode || o?.deliveryMode || "‚Äî";
}

  let allOrders = [];
async function render(list) {
  listEl.innerHTML = "";

  if (!list.length) {
    listEl.innerHTML = `<div style="padding:18px 22px; color: var(--muted); font-weight:700;">
      No orders found.
    </div>`;
    return;
  }

  // Sort in order of Pending, completed, cancelled
const isDone = (o) => {
  const s = normalizeStatus(o.status);
  return s === "completed" || s === "cancelled";
};

const rankStatus = (status) => {
  const s = normalizeStatus(status);
  if (s === "pending") return 0;
  if (s === "in progress") return 1;
  if (s === "cancelled") return 2;
  if (s === "completed") return 3;
  return 4;
};

list.sort((a, b) => {
  const ra = rankStatus(a.status);
  const rb = rankStatus(b.status);

  // primary: status order
  if (ra !== rb) return ra - rb;

  // secondary: newest first within same status
  return (b.createdAt || 0) - (a.createdAt || 0);
});



  for (const o of list) {
    const createdAt = Number(o.createdAt || Date.now());
    const st = normalizeStatus(o.status);

    const endTs =
      st === "completed" ? Number(o.completedAt || o.updatedAt || 0) :
      st === "cancelled" ? Number(o.cancelledAt || o.updatedAt || 0) :
      0;

    const customerName =
      (o.username && String(o.username).trim()) ? String(o.username).trim() : "‚Äî";
    const customerEmail = await getCustomerEmail(o);

    // items for this stall only
    const stallItems = (Array.isArray(o.items) ? o.items : []).filter(
  (it) => String(getStall(it)).trim() === STALL_NAME
);


    const subtotal = subtotalForItems(stallItems);

    // menu item preview lines (max 2 lines)
    const previewLines = stallItems.slice(0, 2).map(it => {
      const n = getItemName(it);
      const q = getQty(it);
      const p = getPrice(it);
      return `${n} - ${q} x $${p.toFixed(2)}`;
    });

    const moreCount = Math.max(0, stallItems.length - 2);
    const previewText = previewLines.length
      ? previewLines.join(" ‚Ä¢ ") + (moreCount ? ` ‚Ä¢ +${moreCount} more` : "")
      : "‚Äî";

    const row = document.createElement("div");
    row.className = "row";

    const itemsCount = stallItems.reduce((sum, it) => sum + getQty(it), 0);
    
    row.innerHTML = `
  <div class="icon">üî•</div>

  <div class="main">
    <!-- LINE 1: Order No + Ordered date/time + timer -->
    <div class="top">
      <div class="aid">${o.orderNo || "‚Äî"}</div>

      <div class="sub" style="margin:0; font-weight:800; color:#344054;">
        ${formatTime(createdAt)}
        <span class="timer"
        data-created="${createdAt}"
        data-status="${st}"
        data-end="${endTs}">
      </span>
      </div>
    </div>

    <!-- LINE 2 -->
    <div class="sub" style="margin-top:8px;">
      <b>Items:</b> ${itemsCount}
      &nbsp; ‚Ä¢ &nbsp; <b>Subtotal:</b> $${subtotal.toFixed(2)}
      &nbsp; ‚Ä¢ &nbsp; <b>Order Mode:</b> ${getOrderMode(o)}
    </div>
  </div>

  <div class="right">
    ${badgeHTML(o.status)}
    <button class="arrow-btn" type="button" title="View details">‚Ä∫</button>
  </div>
`;


    row.querySelector(".arrow-btn").addEventListener("click", (e) => {
      e.stopPropagation();
      openDrawer(o, stallItems, customerName, customerEmail);
    });

    listEl.appendChild(row);
  }

  startTimers(); // updates all the timers
}
let timerInterval = null;

function pad2(n) {
  return String(n).padStart(2, "0");
}

function startTimers() {
  if (timerInterval) clearInterval(timerInterval);

  const computeText = (created, endOrNow) => {
    const diffMs = Math.max(0, endOrNow - created);
    const totalSec = Math.floor(diffMs / 1000);
    const mm = Math.floor(totalSec / 60);
    const ss = totalSec % 60;
    return `${mm}m ${pad2(ss)}s`;
  };

  const update = () => {
  document.querySelectorAll(".timer[data-created]").forEach((el) => {
    const created = Number(el.dataset.created || 0);
    const status = (el.dataset.status || "").toLowerCase();

    let endTs = Number(el.dataset.end || 0);
    const isDone = (status === "completed" || status === "cancelled");

    // ‚úÖ If status is done but endTs is missing, freeze at the first moment we see it done
    if (isDone && (!endTs || isNaN(endTs))) {
      endTs = Date.now();
      el.dataset.end = String(endTs); // store it so it stays frozen
    }

    const endOrNow = isDone ? endTs : Date.now();

    el.textContent = computeText(created, endOrNow);

    // ‚úÖ red after 15 minutes
    const diffMs = Math.max(0, endOrNow - created);
    el.classList.toggle("overdue", diffMs >= 15 * 60 * 1000);
  });
};



  update();
  timerInterval = setInterval(update, 1000);
}



async function updateOrderStatus(orderId, newStatus) {
  try {
    const now = Date.now();

    const patch = {
      status: newStatus,
      updatedAt: now,
    };

    // add datetime fields depending on status
    if (newStatus === "in progress") patch.acceptedAt = now;
    if (newStatus === "completed") patch.completedAt = now;
    if (newStatus === "cancelled") patch.cancelledAt = now;

    await update(ref(db, `orders/${orderId}`), patch);
  } catch (err) {
    console.error("Failed to update order status", err);
    alert("Failed to update order.");
  }
}


function openDrawer(order, stallItems, customerName, customerEmail) {
  const subtotal = subtotalForItems(stallItems);


  $("dTitle").textContent = `Order ${order.orderNo || "‚Äî"}`;
  $("dAID").textContent = order.orderNo || "‚Äî";
  $("dLoc").textContent = customerName || "‚Äî";
  $("dAddr").textContent = customerEmail || "‚Äî";
  $("dTrade").textContent = order.paymentMethod || "‚Äî";
  $("dRent").textContent = `$${subtotal.toFixed(2)}`;
  $("dStart").textContent = formatTime(order.createdAt);
  $("dStatus").textContent = order.status || "Pending";

  $("dNoteTitle").textContent = "Menu Items";
  $("dNotes").textContent = stallItems.length
    ? stallItems.map(it => {
        const n = getItemName(it);
        const q = getQty(it);
        const p = getPrice(it);
        return `${n} - ${q} x $${p.toFixed(2)}`;
      }).join("\n")
    : "‚Äî";

  drawer.classList.add("show");
  drawer.setAttribute("aria-hidden", "false");
const actionsEl = $("drawerActions");
actionsEl.innerHTML = "";

const status = normalizeStatus(order.status);
const orderId = order._key; // ‚úÖ correct firebase id

if (status === "pending") {
  actionsEl.innerHTML = `
    <button class="btn-lite btn-accept" type="button">Accept</button>
    <button class="btn-lite btn-cancel" type="button">Cancel</button>
  `;

  actionsEl.children[0].onclick = async () => {
  if (!confirm("Accept this order? Status will change to In Progress.")) return;
  await updateOrderStatus(orderId, "in progress");
  closeDrawer();
};


  actionsEl.children[1].onclick = async () => {
  if (!confirm("Cancel this order? This cannot be undone.")) return;
  await updateOrderStatus(orderId, "cancelled");
  closeDrawer();
};

} 
else if (status === "in progress") {
  actionsEl.innerHTML = `
    <button class="btn-lite btn-complete" type="button">Completed</button>
    <button class="btn-lite btn-cancel" type="button">Cancel</button>
  `;

  actionsEl.children[0].onclick = async () => {
  if (!confirm("Mark this order as Completed?")) return;
  await updateOrderStatus(orderId, "completed");
  closeDrawer();
};


  actionsEl.children[1].onclick = async () => {
  if (!confirm("Cancel this order? This cannot be undone.")) return;
  await updateOrderStatus(orderId, "cancelled");
  closeDrawer();
};

} 
else {
  actionsEl.innerHTML = `
    <button class="btn-lite btn-ghost" type="button" disabled>
      Order ${status}
    </button>
  `;
}
const st2 = normalizeStatus(order.status);

if (st2 === "cancelled" && order.cancelledAt) {
  $("dNotes").textContent += `\n\nCancelled At: ${formatTime(order.cancelledAt)}`;
}
if (st2 === "completed" && order.completedAt) {
  $("dNotes").textContent += `\n\nCompleted At: ${formatTime(order.completedAt)}`;
}
drawer.classList.add("show");
drawer.setAttribute("aria-hidden", "false");
}


  function closeDrawer() {
    drawer.classList.remove("show");
    drawer.setAttribute("aria-hidden", "true");
  }

  overlay.addEventListener("click", closeDrawer);
  closeBtn.addEventListener("click", closeDrawer);

  function applyFilter() {
    const v = filterEl.value; // all / pending / in progress / completed / cancelled
    const filtered = (v === "all")
      ? allOrders
      : allOrders.filter(o => normalizeStatus(o.status) === v);

    render(filtered);
  }

  filterEl.addEventListener("change", applyFilter);

  // Read orders and keep ONLY those that include Banana Leaf Nasi Lemak items
  onValue(ref(db, "orders"), (snap) => {
  const data = snap.val() || {};

  const orders = Object.entries(data).map(([key, o]) => ({
    _key: key, // ‚úÖ keep firebase key
    ...o,
    status: o?.status || "Pending",
    createdAt: (typeof o?.createdAt === "number") ? o.createdAt : Date.now(),
    items: normalizeItems(o?.items),
  }));

  allOrders = orders.filter(o =>
    o.items.some(it => String(getStall(it)).trim() === STALL_NAME)
  );

  applyFilter();
});


</script>
    <script type="module" src="Master_page_javascript.js"></script>
  </body>
</html>