<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rewards Page</title>
    <link rel="stylesheet" href="Master_page_stylesheet.css" />

    <!-- ‚úÖ Kodchasan for NAV -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kodchasan:wght@600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }

      :root {
        --primary-orange: #ff8c3a;
        --primary-yellow: #ffd400;
        --grey-lock: #eee;
        --grey-text: #888;
      }

      body {
        background: #fff;
        color: #222;
      }

      /* =========================
         NAVIGATION (UPDATED FONT)
      ========================= */
      .navrectangle {
        background: white;
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 10px 40px;
        border-bottom: 1px solid #eee;

        font-family: "Kodchasan", Arial, sans-serif;
      }

      .top-nav {
        display: grid;
        grid-template-columns: auto 1fr auto auto; /* ‚úÖ logo | menu | reserve | hamburger */
        align-items: center;
        gap: 14px;
      }

      .Logo {
        height: 60px;
        display: flex;
        align-items: center;
      }

      .Logo img {
        height: 100%;
        width: auto;
      }

      .menu {
        display: flex;
        justify-content: center;
        list-style: none;
        gap: 50px;
      }

      .menu a {
        text-decoration: none;
        font-weight: 800;
        font-size: 15px; /* ‚úÖ match friend */
        color: #111;
        font-family: "Kodchasan", Arial, sans-serif;
      }

      .menu a:hover {
        color: var(--primary-orange);
      }

      .menu-item {
        position: relative;
      }

      .dropdown {
        position: absolute;
        top: 130%;
        left: 0;
        background: var(--primary-yellow);
        border-radius: 12px;
        padding: 10px 0;
        min-width: 160px;
        display: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .dropdown li {
        list-style: none;
      }

      .dropdown a {
        display: block;
        padding: 10px 18px;
        color: #111;
        font-size: 15px;
        font-weight: 800;
        font-family: "Kodchasan", Arial, sans-serif;
      }

      .dropdown a:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      .menu-item:hover .dropdown {
        display: block;
      }

      /* ‚úÖ Reserve a Table button (RESTORED) */
      .reserve-btn {
        background: var(--primary-orange);
        color: white;
        border: 3px solid var(--primary-orange);
        padding: 14px 30px;
        border-radius: 22px;
        font-weight: 800;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.25s ease;
        font-family: Arial, Helvetica, sans-serif;
        white-space: nowrap;
      }

      .reserve-btn:hover {
        background: white;
        color: var(--primary-orange);
      }

      /* =========================
         MOBILE DRAWER NAV
      ========================= */
      .hamburger {
        display: none;
        flex-direction: column;
        justify-content: center;
        gap: 5px;
        cursor: pointer;
        user-select: none;
      }

      .hamburger div {
        width: 22px;
        height: 2px;
        background: #111;
        border-radius: 1px;
      }

      .nav-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        z-index: 1500;
      }
      .nav-overlay.show {
        display: block;
      }

      @media (max-width: 700px) {
        .top-nav {
          grid-template-columns: auto 1fr auto; /* logo | spacer | hamburger */
        }

        /* ‚úÖ hide reserve on mobile */
        .reserve-btn {
          display: none;
        }

        .hamburger {
          display: flex;
          justify-self: end;
        }

        .menu {
          position: fixed;
          top: 0;
          right: 0;
          height: 100vh;
          width: min(86vw, 360px);
          background: #fff;

          padding: 90px 16px 18px;
          border-left: 1px solid #eee;
          box-shadow: -18px 0 40px rgba(0, 0, 0, 0.16);

          display: flex;
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-start;
          gap: 10px;

          transform: translateX(110%);
          transition: transform 0.25s ease;
          z-index: 1600;
        }

        .menu.show {
          transform: translateX(0);
        }

        .menu > .menu-item > a {
          width: 100%;
          display: flex;
          justify-content: center;
          text-align: center;

          padding: 12px 14px;
          border-radius: 14px;

          color: #9a9a9a;
          font-weight: 800;
          font-size: 15px;
          font-family: "Kodchasan", Arial, sans-serif;
        }

        .dropdown {
          position: static;
          min-width: unset;
          width: 100%;
          margin: 6px 0 12px;
          padding: 10px;

          background: rgba(214, 112, 39, 0.12);
          border-radius: 14px;
          box-shadow: none;

          display: block;
        }

        .dropdown a {
          border-radius: 12px;
          text-align: center;
          padding: 12px 14px;
        }

        .menu-item:hover .dropdown {
          display: block;
        }
      }

      /* MAIN REWARDS */
      main {
        padding: 50px 20px 60px;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
      }

      .subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 20px;
      }

      /* PROMO BOX */
      .promo-wrap {
        max-width: 1100px;
        margin: 0 auto 28px;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        padding: 18px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .promo-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 220px;
      }

      .promo-title {
        font-weight: 800;
        color: #111;
        font-size: 16px;
      }

      .promo-sub {
        color: #555;
        font-size: 13px;
      }

      .promo-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
        flex: 1;
      }

      .promo-input {
        height: 42px;
        padding: 0 12px;
        border-radius: 999px;
        border: 1px solid #e5e5e5;
        outline: none;
        min-width: 240px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .promo-input:focus {
        border-color: rgba(228, 115, 41, 0.5);
        box-shadow: 0 0 0 3px rgba(228, 115, 41, 0.12);
      }

      .promo-msg {
        width: 100%;
        font-size: 13px;
        color: #555;
        margin-top: 2px;
      }

      .promo-msg.ok {
        color: #1f8b2e;
        font-weight: 700;
      }

      .promo-msg.bad {
        color: #c0392b;
        font-weight: 700;
      }

      /* stable layout */
      .rewards-container {
        max-width: 1100px;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, minmax(260px, 1fr));
        gap: 25px;
        align-items: start;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s;
        min-height: 280px;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .icon {
        font-size: 45px;
        margin-bottom: 15px;
        color: var(--primary-orange);
      }

      .card h2 {
        color: var(--primary-orange);
        margin-bottom: 10px;
      }

      .card p {
        color: #444;
        margin-bottom: 20px;
        font-size: 15px;
      }

      .btn {
        background: var(--primary-orange);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      .btn:hover {
        filter: brightness(0.98);
      }

      .code-box {
        border: 2px dashed var(--primary-orange);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: bold;
        color: var(--primary-orange);
      }

      /* LOCKED */
      .card.locked {
        background: var(--grey-lock);
        color: var(--grey-text);
      }
      .card.locked h2,
      .card.locked p,
      .card.locked .icon,
      .card.locked .code-box {
        color: var(--grey-text) !important;
        border-color: #bbb !important;
      }
      .btn.locked {
        background: var(--grey-lock);
        color: var(--grey-text);
        cursor: not-allowed;
      }

      /* USED (same grey as locked) */
      .card.used {
        background: var(--grey-lock) !important;
        color: var(--grey-text) !important;
      }
      .card.used h2,
      .card.used p,
      .card.used .icon,
      .card.used .code-box {
        color: var(--grey-text) !important;
        border-color: #bbb !important;
      }
      .card.used .btn {
        background: var(--grey-lock) !important;
        color: var(--grey-text) !important;
        cursor: not-allowed !important;
      }

      /* POPUP (existing overlay class) */
      .reward-popup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
      }

      .reward-popup.show {
        display: flex;
      }

      .popup-card {
        width: 100%;
        max-width: 360px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25);
        padding: 24px 22px;
        text-align: center;
        transform: scale(0.92);
        opacity: 0;
        transition: all 0.25s ease;
      }

      .reward-popup.show .popup-card {
        transform: scale(1);
        opacity: 1;
      }

      .popup-card h3 {
        color: var(--primary-orange);
        margin-bottom: 10px;
      }

      .popup-card p {
        margin-bottom: 18px;
        color: #333;
      }

      .popup-close {
        background: var(--primary-orange);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: bold;
      }

      /* WHEEL */
      .wheel-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 10px auto 14px;
      }

      #wheel {
        width: 300px;
        height: 300px;
        border-radius: 50%;
        display: block;
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.22);
      }

      /* pointer on RIGHT */
      #wheel-pointer {
        position: absolute;
        top: 50%;
        right: -18px;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 14px solid transparent;
        border-bottom: 14px solid transparent;
        border-left: 22px solid #2ecc71;
        filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2));
      }

      #card-spin {
        order: 9999;
      }

      /* REFER */
      .refer {
        margin: 60px auto 0;
        max-width: 1100px;
        background: linear-gradient(135deg, #e47329, #ff944d);
        color: white;
        padding: 30px;
        border-radius: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .refer button {
        background: white;
        color: var(--primary-orange);
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
      }

      /* MOBILE */
      @media (max-width: 980px) {
        .rewards-container {
          grid-template-columns: repeat(2, minmax(260px, 1fr));
        }
      }
      @media (max-width: 700px) {
        .rewards-container {
          grid-template-columns: 1fr;
        }
      }

      /* TERMS POPUP */
      .terms-card {
        max-width: 780px;
        text-align: left;
      }
      .terms-meta {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
      }
      .terms-scroll {
        max-height: 60vh;
        overflow: auto;
        padding-right: 6px;
        margin: 12px 0 16px;
      }
      .terms-scroll h4 {
        margin: 14px 0 6px;
        color: #111;
        font-size: 15px;
      }
      .terms-scroll p,
      .terms-scroll li {
        font-size: 14px;
        line-height: 1.55;
        color: #333;
      }
      .terms-scroll ul {
        margin: 6px 0 10px 18px;
      }
      .terms-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }
      .terms-actions .popup-close {
        margin: 0;
      }
      .terms-actions .btn-secondary {
        background: #fff;
        color: var(--primary-orange);
        border: 2px solid var(--primary-orange);
        padding: 10px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: bold;
      }

      /* =========================================================
         Voucher confirm modal (YES/NO)
      ========================================================= */
      .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .btn-secondary {
        background: #fff;
        color: var(--primary-orange);
        border: 2px solid var(--primary-orange);
        padding: 10px 20px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 800;
      }
      .btn-secondary:hover {
        filter: brightness(0.98);
      }
      .confirm-note {
        font-size: 13px;
        color: #666;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <!-- overlay for mobile drawer -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- NAVIGATION -->
    <nav class="navrectangle">
      <header class="top-nav">
        <div class="Logo">
          <img src="/images/ShiokLah(cropped).jpeg" alt="Logo" />
        </div>

        <nav>
          <ul class="menu" id="menu">
            <li class="menu-item">
              <a href="FED_ASG.html">Home</a>
              <ul class="dropdown">
                <li><a href="#">Start Order</a></li>
              </ul>
            </li>

            <li class="menu-item">
              <a href="OrderHistory.html">Order History</a>
              <ul class="dropdown">
                <li><a href="OrderHistory.html">Past Orders</a></li>
              </ul>
            </li>

            <li class="menu-item">
              <a href="#">Profile</a>
              <ul class="dropdown">
                <li><a href="UserProfile.html">Overview</a></li>
                <li><a href="Analytics.html">Analytics & Reporting</a></li>
                <li><a href="CustomerFeedback.html">Customer Feedback</a></li>
                <li>
                  <a href="Regulatory&Complianceinfo.html"
                    >Regulatory & Compliance</a
                  >
                </li>
                <li><a href="Customer_Favourties.html">Favourites</a></li>
                <li>
                  <a href="Customer Vouchers and Rewards.html">Rewards</a>
                </li>
              </ul>
            </li>

            <li class="menu-item"><a href="SelectRole.html">Log Out</a></li>
          </ul>
        </nav>

        <!-- ‚úÖ RESTORED Reserve button (change href/page if your filename is different) -->
        <button
          class="reserve-btn"
          type="button"
          onclick="window.location.href = 'Reservation.html'"
        >
          Reserve a Table
        </button>

        <!-- hamburger -->
        <div
          class="hamburger"
          id="hamburger"
          aria-label="Open menu"
          role="button"
          tabindex="0"
        >
          <div></div>
          <div></div>
          <div></div>
        </div>
      </header>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
      <h1>üéÅ Rewards</h1>
      <p class="subtitle">Unlock exclusive offers just for you</p>

      <!-- PROMO CODE INPUT FEATURE -->
      <div class="promo-wrap" id="promo-wrap">
        <div class="promo-left">
          <div class="promo-title">Have a promo code?</div>
          <div class="promo-sub">
            Enter a code to unlock rewards or redeem a voucher.
          </div>
        </div>

        <div class="promo-right">
          <input
            class="promo-input"
            id="promo-input"
            type="text"
            placeholder="e.g. SAVE15"
            autocomplete="off"
            inputmode="latin"
          />
          <button class="btn" id="promo-apply">Apply</button>
          <div class="promo-msg" id="promo-msg"></div>
        </div>
      </div>

      <div class="rewards-container" id="rewards-grid">
        <!-- ACTIVE (not grey) vouchers -->
        <div
          class="card"
          data-reward-id="discount-20"
          data-voucher="true"
          data-voucher-name="20% OFF"
          data-voucher-type="percent"
          data-voucher-value="20"
          data-voucher-code="OFF20"
          data-voucher-min="0"
        >
          <div class="icon">üè∑Ô∏è</div>
          <h2>20% OFF</h2>
          <p>Get 20% off your next order</p>
          <div class="code-box">OFF20</div>
          <button class="btn use-voucher-btn">Use voucher</button>
        </div>

        <div
          class="card"
          data-reward-id="gift-10"
          data-voucher="true"
          data-voucher-name="$10 Voucher"
          data-voucher-type="fixed"
          data-voucher-value="10"
          data-voucher-code="TENOFF"
          data-voucher-min="15"
        >
          <div class="icon">üéÅ</div>
          <h2>$10 Voucher</h2>
          <p>$10 off (min spend $15)</p>
          <div class="code-box">TENOFF</div>
          <button class="btn use-voucher-btn">Use voucher</button>
        </div>

        <div
          class="card"
          data-reward-id="save-15"
          data-voucher="true"
          data-voucher-name="Save $15"
          data-voucher-type="fixed"
          data-voucher-value="15"
          data-voucher-code="SAVE15"
          data-voucher-min="25"
        >
          <div class="icon">‚úÇÔ∏è</div>
          <h2>Save $15</h2>
          <p>$15 off (min spend $25)</p>
          <div class="code-box">SAVE15</div>
          <button class="btn use-voucher-btn">Use voucher</button>
        </div>

        <!-- MORE ACTIVE vouchers -->
        <div
          class="card"
          data-reward-id="free-delivery"
          data-voucher="true"
          data-voucher-name="Free Takeaway"
          data-voucher-type="fixed"
          data-voucher-value="0"
          data-voucher-code="TAKE2"
          data-voucher-min="10"
        >
          <div class="icon">üöö</div>
          <h2>Free Takeaway</h2>
          <div class="code-box">TAKE2</div>
          <button class="btn use-voucher-btn">Use voucher</button>
        </div>

        <div class="card" data-reward-id="bonus-points">
          <div class="icon">üí∞</div>
          <h2>Bonus Points</h2>
          <p>Get extra points on your next purchase</p>
          <button class="btn use-btn">Use now</button>
        </div>

        <div
          class="card locked"
          data-reward-id="mega-25"
          data-voucher="true"
          data-voucher-name="Save $25"
          data-voucher-type="fixed"
          data-voucher-value="25"
          data-voucher-code="MEGA25"
          data-voucher-min="60"
        >
          <div class="icon">üîí</div>
          <h2>Save $25</h2>
          <p>Locked (example). Use promo MEGA25 to add it.</p>
          <div class="code-box">MEGA25</div>
          <button class="btn locked" disabled>You can't use this yet</button>
        </div>

        <!-- Lucky Spin (always last) -->
        <div class="card" id="card-spin">
          <div class="icon">üé°</div>
          <h2>Lucky Spin</h2>
          <p>Spin & win exciting prizes</p>

          <div class="wheel-container">
            <canvas id="wheel" width="300" height="300"></canvas>
            <div id="wheel-pointer" aria-hidden="true"></div>
          </div>

          <button class="btn" id="lucky-spin">Spin</button>
          <p
            id="spin-timer"
            style="font-size: 14px; color: #555; margin-top: 10px"
          ></p>
        </div>
      </div>

      <div class="refer">
        <h2>Terms and Conditions</h2>
        <button id="open-terms">Read</button>
      </div>
    </main>

    <!-- EXISTING POPUP -->
    <div class="reward-popup" id="reward-popup">
      <div class="popup-card">
        <h3 id="popup-title">You won!</h3>
        <p id="popup-text"></p>
        <button class="popup-close" id="popup-close">Nice!</button>
      </div>
    </div>

    <!-- TERMS POPUP -->
    <div class="reward-popup" id="terms-popup" aria-hidden="true">
      <div
        class="popup-card terms-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="terms-title"
      >
        <h3 id="terms-title">ShiokLah! Rewards ‚Äì Terms & Conditions</h3>
        <div class="terms-meta">
          Last updated: <b>7 Feb 2026</b> ‚Ä¢ Applies to vouchers, points,
          promotions and Lucky Spin
        </div>

        <div class="terms-scroll" id="terms-scroll">
          <h4>1. Who we are</h4>
          <p>
            ShiokLah! (‚Äú<b>ShiokLah</b>‚Äù, ‚Äú<b>we</b>‚Äù, ‚Äú<b>us</b>‚Äù) is a hawker
            centre ordering platform that connects customers with participating
            stalls. These Terms & Conditions (‚Äú<b>Terms</b>‚Äù) govern your access
            to and use of the Rewards page, vouchers, coupons, points,
            promotions, referrals, and Lucky Spin (collectively, ‚Äú<b
              >Rewards Features</b
            >‚Äù).
          </p>

          <h4>2. Eligibility</h4>
          <ul>
            <li>You must have a ShiokLah account.</li>
            <li>Rewards are for personal use only.</li>
          </ul>

          <h4>3. Voucher usage</h4>
          <ul>
            <li>Vouchers may have minimum spend.</li>
            <li>Vouchers may not stack unless stated.</li>
            <li>Expired vouchers cannot be reinstated.</li>
          </ul>

          <h4>4. Contact</h4>
          <p>For demo builds, contact your project team support channel.</p>
        </div>

        <div class="terms-actions">
          <button class="btn-secondary" id="terms-scroll-top">
            Back to top
          </button>
          <button class="popup-close" id="terms-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Voucher confirmation popup (YES/NO) -->
    <div class="reward-popup" id="voucher-confirm-popup" aria-hidden="true">
      <div class="popup-card" role="dialog" aria-modal="true">
        <h3 id="voucher-confirm-title">Use voucher now?</h3>
        <p id="voucher-confirm-text"></p>

        <div class="confirm-actions">
          <button class="btn-secondary" id="voucher-no">No</button>
          <button class="popup-close" id="voucher-yes">Yes</button>
        </div>

        <div class="confirm-note">
          If you click <b>Yes</b>, you‚Äôll be sent back to checkout and your
          total will be updated.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /***********************
         * üî• RESET EVERYTHING (UNLOCK ALL)
         * removes all used/locked states + promo history
         ***********************/
        localStorage.removeItem("shiok_used_rewards_v1"); // normal rewards
        localStorage.removeItem("shiok_used_vouchers_v1"); // vouchers
        localStorage.removeItem("shiok_applied_promos_v1"); // promo codes (HELLO123 etc)
        localStorage.removeItem("shiok_earned_rewards_v1"); // lucky spin rewards
        localStorage.removeItem("shiok_spin_cooldown_v1"); // spin timer

        sessionStorage.removeItem("shiok_applied_voucher_v1"); // applied voucher at checkout

        /***********************
         * IMPORTANT: SET YOUR CHECKOUT PAGE FILENAME HERE
         ***********************/
        const CHECKOUT_PAGE = "OrderSummary.html"; // <-- change if needed

        /***********************
         * SETTINGS
         ***********************/
        const ENABLE_COOLDOWN = true;
        const COOLDOWN_HOURS = 48;

        /***********************
         * STORAGE KEYS
         ***********************/
        const USED_KEY = "shiok_used_rewards_v1";
        const EARNED_KEY = "shiok_earned_rewards_v1";
        const COOLDOWN_KEY = "shiok_spin_cooldown_v1";
        const PROMO_KEY = "shiok_applied_promos_v1";

        // ‚úÖ OrderSummary reads this
        const APPLIED_VOUCHER_KEY = "shiok_applied_voucher_v1";

        // ‚úÖ remember voucher was consumed/used -> grey out next time
        const VOUCHER_USED_KEY = "shiok_used_vouchers_v1";

        // ‚úÖ checkout total key (your checkout page should save subtotal/total here)
        const TOTAL_KEY = "shiok_checkout_total_v1";

        // ‚úÖ UNGREY ALL vouchers again (for testing)
        localStorage.removeItem(VOUCHER_USED_KEY);

        const getJSON = (k, fallback) => {
          try {
            const v = localStorage.getItem(k);
            return v ? JSON.parse(v) : fallback;
          } catch {
            return fallback;
          }
        };
        const setJSON = (k, val) =>
          localStorage.setItem(k, JSON.stringify(val));

        function getCheckoutTotal() {
          const raw =
            sessionStorage.getItem(TOTAL_KEY) ||
            localStorage.getItem(TOTAL_KEY);
          const n = raw == null ? NaN : Number(raw);
          return Number.isFinite(n) ? n : NaN;
        }

        /***********************
         * POPUP (existing)
         ***********************/
        const popup = document.getElementById("reward-popup");
        const popupText = document.getElementById("popup-text");
        const popupClose = document.getElementById("popup-close");

        function showPopup(msg) {
          popupText.textContent = msg;
          popup.classList.add("show");
        }
        popupClose.addEventListener("click", () =>
          popup.classList.remove("show"),
        );
        popup.addEventListener("click", (e) => {
          if (e.target === popup) popup.classList.remove("show");
        });

        /***********************
         * TERMS POPUP
         ***********************/
        const openTermsBtn = document.getElementById("open-terms");
        const termsPopup = document.getElementById("terms-popup");
        const termsCloseBtn = document.getElementById("terms-close");
        const termsScrollTopBtn = document.getElementById("terms-scroll-top");
        const termsScroll = document.getElementById("terms-scroll");

        function openTerms() {
          if (!termsPopup) return;
          termsPopup.classList.add("show");
          termsPopup.setAttribute("aria-hidden", "false");
        }
        function closeTerms() {
          if (!termsPopup) return;
          termsPopup.classList.remove("show");
          termsPopup.setAttribute("aria-hidden", "true");
        }

        if (openTermsBtn) openTermsBtn.addEventListener("click", openTerms);
        if (termsCloseBtn) termsCloseBtn.addEventListener("click", closeTerms);
        if (termsScrollTopBtn && termsScroll) {
          termsScrollTopBtn.addEventListener("click", () =>
            termsScroll.scrollTo({ top: 0, behavior: "smooth" }),
          );
        }
        if (termsPopup) {
          termsPopup.addEventListener("click", (e) => {
            if (e.target === termsPopup) closeTerms();
          });
        }

        /***********************
         * DESKTOP NOTIFICATION
         ***********************/
        function notifyNewReward(title, body) {
          if (!("Notification" in window)) return;

          if (Notification.permission === "granted") {
            new Notification(title, { body });
            return;
          }

          if (Notification.permission !== "denied") {
            Notification.requestPermission().then((perm) => {
              if (perm === "granted") new Notification(title, { body });
            });
          }
        }

        async function ensureNotificationsAllowed() {
          if (!("Notification" in window)) return false;
          if (Notification.permission === "granted") return true;
          if (Notification.permission === "denied") return false;

          try {
            const perm = await Notification.requestPermission();
            return perm === "granted";
          } catch {
            return false;
          }
        }

        /***********************
         * USED (persist) for non-voucher "Use now"
         ***********************/
        const usedIds = new Set(getJSON(USED_KEY, []));

        function applyUsedState(card, btn) {
          card.classList.add("used");
          if (btn) {
            btn.textContent = "Used";
            btn.disabled = true;
          }
        }

        document.querySelectorAll(".card[data-reward-id]").forEach((card) => {
          const id = card.getAttribute("data-reward-id");
          const btn = card.querySelector(".use-btn");
          if (usedIds.has(id) && btn) applyUsedState(card, btn);
        });

        document.querySelectorAll(".use-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const card = btn.closest(".card");
            const id = card?.getAttribute("data-reward-id");
            if (!card || !id) return;
            if (card.classList.contains("used")) return;

            const minSpend = Number(card.getAttribute("data-voucher-min") || 0);
            const checkoutTotal = getCheckoutTotal();
            const totalForCheck = Number.isFinite(checkoutTotal)
              ? checkoutTotal
              : 0;

            /* ‚úÖ minimum spend check */
            if (minSpend > 0 && totalForCheck < minSpend) {
              showPopup(`You need a minimum spending of $${minSpend}`);
              return;
            }

            /* ‚úÖ mark used */
            applyUsedState(card, btn);
            usedIds.add(id);
            setJSON(USED_KEY, Array.from(usedIds));

            /* ‚úÖ ALWAYS go checkout */
            window.location.href = CHECKOUT_PAGE;
          });
        });

        /***********************
         * ‚úÖ VOUCHER USED (persist) -> grey out voucher cards
         ***********************/
        const usedVoucherIds = new Set(getJSON(VOUCHER_USED_KEY, []));

        function applyVoucherUsedState(card) {
          if (!card) return;
          card.classList.add("used");

          const btn = card.querySelector(".use-voucher-btn");
          if (btn) {
            btn.textContent = "Used";
            btn.disabled = true;
            btn.classList.add("locked");
          }
        }

        document
          .querySelectorAll(".card[data-voucher='true']")
          .forEach((card) => {
            const id = card.getAttribute("data-reward-id");
            if (id && usedVoucherIds.has(id)) {
              applyVoucherUsedState(card);
            }
          });

        /***********************
         * EARNED REWARDS (from wheel)
         ***********************/
        const grid = document.getElementById("rewards-grid");
        const spinCard = document.getElementById("card-spin");
        const earnedRewards = getJSON(EARNED_KEY, []);

        function createEarnedCard(reward) {
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-reward-id", reward.id);

          card.innerHTML = `
            <div class="icon">${reward.icon}</div>
            <h2>${reward.title}</h2>
            <p>${reward.desc}</p>
            <button class="btn use-btn">Use now</button>
          `;

          const btn = card.querySelector(".use-btn");
          btn.addEventListener("click", () => {
            if (card.classList.contains("used")) return;
            applyUsedState(card, btn);
            usedIds.add(reward.id);
            setJSON(USED_KEY, Array.from(usedIds));
          });

          if (usedIds.has(reward.id)) applyUsedState(card, btn);
          return card;
        }

        earnedRewards.forEach((r) =>
          grid.insertBefore(createEarnedCard(r), spinCard),
        );

        function addEarnedReward(reward) {
          if (earnedRewards.some((r) => r.id === reward.id)) return;
          earnedRewards.push(reward);
          setJSON(EARNED_KEY, earnedRewards);
          grid.insertBefore(createEarnedCard(reward), spinCard);
        }

        /***********************
         * CONFETTI
         ***********************/
        function confettiBurst() {
          const colors = [
            "#FF9F1C",
            "#FFD166",
            "#06D6A0",
            "#4CC9F0",
            "#F72585",
          ];
          const count = 320;

          for (let i = 0; i < count; i++) {
            const p = document.createElement("div");
            const size = 6 + Math.random() * 10;

            p.style.position = "fixed";
            p.style.left = "50%";
            p.style.top = "25%";
            p.style.width = size + "px";
            p.style.height = size + "px";
            p.style.background =
              colors[Math.floor(Math.random() * colors.length)];
            p.style.borderRadius = Math.random() > 0.5 ? "50%" : "2px";
            p.style.zIndex = "9999";
            p.style.pointerEvents = "none";
            document.body.appendChild(p);

            const angle = Math.random() * Math.PI * 2;
            const power = 220 + Math.random() * 420;
            const dx = Math.cos(angle) * power;
            const dy = Math.sin(angle) * power - (180 + Math.random() * 120);
            const rotate = Math.random() * 900 - 450 + "deg";

            requestAnimationFrame(() => {
              p.style.transition =
                "transform 1.9s ease-out, opacity 1.9s ease-out";
              p.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate})`;
              p.style.opacity = "0";
            });

            setTimeout(() => p.remove(), 2000);
          }
        }

        /***********************
         * SPIN COOLDOWN (48h persist)
         ***********************/
        const spinBtn = document.getElementById("lucky-spin");
        const timerEl = document.getElementById("spin-timer");

        function getCooldownEnd() {
          const raw = localStorage.getItem(COOLDOWN_KEY);
          if (!raw) return null;
          const d = new Date(raw);
          return isNaN(d.getTime()) ? null : d;
        }
        function setCooldownEnd(dateObj) {
          localStorage.setItem(COOLDOWN_KEY, dateObj.toISOString());
        }
        function clearCooldown() {
          localStorage.removeItem(COOLDOWN_KEY);
        }

        function updateCooldownUI() {
          if (!ENABLE_COOLDOWN) {
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const end = getCooldownEnd();
          if (!end) {
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const diff = end - new Date();
          if (diff <= 0) {
            clearCooldown();
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const h = Math.floor(diff / (1000 * 60 * 60));
          const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((diff % (1000 * 60)) / 1000);

          timerEl.textContent = `Next spin in: ${h}h ${m}m ${s}s`;
          spinBtn.disabled = true;
          spinBtn.style.background = "var(--grey-lock)";
          spinBtn.style.color = "var(--grey-text)";
          spinBtn.style.cursor = "not-allowed";
        }

        setInterval(updateCooldownUI, 1000);
        updateCooldownUI();

        /***********************
         * WHEEL
         ***********************/
        const wheel = document.getElementById("wheel");
        const ctx = wheel.getContext("2d");
        const radius = wheel.width / 2;

        const prizes = [
          {
            key: "5",
            title: "$5 Voucher",
            desc: "Use $5 off your next order",
            icon: "üíµ",
          },
          {
            key: "try",
            title: "Try Again",
            desc: "You get a second chance to spin!",
            icon: "üîÅ",
          },
          {
            key: "10",
            title: "$10 Voucher",
            desc: "Use $10 off your next order",
            icon: "üíµ",
          },
          {
            key: "points",
            title: "Bonus Points",
            desc: "Get extra points on your next purchase",
            icon: "üí∞",
          },
          {
            key: "15",
            title: "$15 Voucher",
            desc: "Use $15 off your next order",
            icon: "üíµ",
          },
        ];

        function drawWheel() {
          const colors = [
            "#2d6cdf",
            "#ff3ea5",
            "#e53935",
            "#ffd400",
            "#1f8b2e",
          ];
          const slice = (2 * Math.PI) / prizes.length;

          ctx.clearRect(0, 0, wheel.width, wheel.height);

          for (let i = 0; i < prizes.length; i++) {
            const start = i * slice;
            const end = start + slice;

            ctx.beginPath();
            ctx.moveTo(radius, radius);
            ctx.arc(radius, radius, radius, start, end);
            ctx.closePath();
            ctx.fillStyle = colors[i];
            ctx.fill();

            ctx.lineWidth = 4;
            ctx.strokeStyle = "rgba(255,255,255,0.9)";
            ctx.stroke();

            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(start + slice / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 16px Segoe UI";
            ctx.fillText(
              prizes[i].title.replace("Voucher", ""),
              radius - 16,
              6,
            );
            ctx.restore();
          }

          ctx.beginPath();
          ctx.arc(radius, radius, 42, 0, Math.PI * 2);
          ctx.fillStyle = "#fff";
          ctx.fill();
        }

        drawWheel();

        let spinning = false;

        spinBtn.addEventListener("click", async () => {
          await ensureNotificationsAllowed();
          if (spinning) return;
          if (spinBtn.disabled) return;

          spinning = true;

          const selectedIndex = Math.floor(Math.random() * prizes.length);
          const sliceAngle = 360 / prizes.length;
          const targetDeg = selectedIndex * sliceAngle + sliceAngle / 2;
          const turns = 6;
          const rotation = turns * 360 - targetDeg;

          wheel.style.transition = "transform 4s cubic-bezier(.17,.67,.12,.99)";
          wheel.style.transform = `rotate(${rotation}deg)`;

          wheel.addEventListener(
            "transitionend",
            async function handler() {
              wheel.removeEventListener("transitionend", handler);
              wheel.style.transition = "";

              const reward = prizes[selectedIndex];

              if (reward.key === "try") {
                showPopup("You get a second chance to spin!");
                notifyNewReward(
                  "ShiokLah! Lucky Spin üé°",
                  "You get a second chance to spin!",
                );
              } else {
                const rewardId = `spin-${reward.key}`;

                addEarnedReward({
                  id: rewardId,
                  title: reward.title,
                  desc: reward.desc,
                  icon: reward.icon,
                });

                confettiBurst();
                showPopup(`You won: ${reward.title}! üéâ`);

                notifyNewReward(
                  "ShiokLah! Reward Unlocked üéÅ",
                  `You received: ${reward.title}`,
                );
                notifyNewReward(
                  "ShiokLah! Rewards Updated ‚úÖ",
                  "Your Rewards page has been updated.",
                );

                if (ENABLE_COOLDOWN) {
                  const end = new Date(
                    Date.now() + COOLDOWN_HOURS * 60 * 60 * 1000,
                  );
                  setCooldownEnd(end);
                  updateCooldownUI();
                }
              }

              spinning = false;
            },
            { once: true },
          );
        });

        /***********************
         * PROMO CODE FEATURE
         ***********************/
        const promoInput = document.getElementById("promo-input");
        const promoApply = document.getElementById("promo-apply");
        const promoMsg = document.getElementById("promo-msg");
        const appliedPromos = new Set(getJSON(PROMO_KEY, []));

        function setPromoMessage(text, type) {
          if (!promoMsg) return;
          promoMsg.textContent = text || "";
          promoMsg.classList.remove("ok", "bad");
          if (type === "ok") promoMsg.classList.add("ok");
          if (type === "bad") promoMsg.classList.add("bad");
        }

        function unlockCard(card) {
          if (!card) return false;
          if (!card.classList.contains("locked")) return false;

          card.classList.remove("locked");

          const oldBtn = card.querySelector("button.btn.locked");
          if (oldBtn) oldBtn.remove();

          const newBtn = document.createElement("button");
          newBtn.className = "btn use-voucher-btn";
          newBtn.textContent = "Use voucher";
          card.appendChild(newBtn);

          return true;
        }

        const PROMO_ACTIONS = {
          MEGA25: {
            type: "unlock",
            rewardId: "mega-25",
            msg: "Unlocked: Save $25!",
          },
          HELLO123: {
            type: "discount",
            amount: 2.5,
            msg: "Promo applied: $2.50 OFF!",
          },
        };

        async function applyPromoCode() {
          await ensureNotificationsAllowed();

          const raw = promoInput?.value || "";
          const code = raw.trim().toUpperCase();

          if (!code) {
            setPromoMessage("Enter a promo code first.", "bad");
            return;
          }

          const action = PROMO_ACTIONS[code];
          if (!action) {
            setPromoMessage("INVALID promo code.", "bad");
            notifyNewReward("ShiokLah! Promo Code ‚ùå", "INVALID promo code.");
            return;
          }

          if (appliedPromos.has(code)) {
            setPromoMessage("This promo code was already used.", "bad");
            notifyNewReward(
              "ShiokLah! Promo Code",
              "This promo code was already used.",
            );
            return;
          }

          if (action.type === "unlock") {
            const card = document.querySelector(
              `.card[data-reward-id="${action.rewardId}"]`,
            );
            unlockCard(card);

            appliedPromos.add(code);
            setJSON(PROMO_KEY, Array.from(appliedPromos));

            setPromoMessage(action.msg, "ok");
            if (promoInput) promoInput.value = "";

            notifyNewReward("ShiokLah! Promo Applied ‚úÖ", action.msg);
            notifyNewReward(
              "ShiokLah! Rewards Updated ‚úÖ",
              "Your Rewards page has been updated.",
            );

            bindVoucherButtons();
            return;
          }

          if (action.type === "discount") {
            const promoAsVoucherObj = {
              id: "promo-hello123",
              label: "HELLO123 Promo ($2.50 OFF)",
              code: "HELLO123",
              type: "fixed",
              amount: action.amount,
              minSpend: 0,
              selectedAt: new Date().toISOString(),
            };

            sessionStorage.setItem(
              APPLIED_VOUCHER_KEY,
              JSON.stringify(promoAsVoucherObj),
            );

            appliedPromos.add(code);
            setJSON(PROMO_KEY, Array.from(appliedPromos));

            setPromoMessage(action.msg, "ok");
            if (promoInput) promoInput.value = "";

            notifyNewReward("ShiokLah! Promo Applied ‚úÖ", action.msg);

            window.location.href = CHECKOUT_PAGE;
          }
        }

        if (promoApply) promoApply.addEventListener("click", applyPromoCode);
        if (promoInput) {
          promoInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") applyPromoCode();
          });
        }

        /* Voucher confirm */
        const confirmPopup = document.getElementById("voucher-confirm-popup");
        const confirmText = document.getElementById("voucher-confirm-text");
        const btnYes = document.getElementById("voucher-yes");
        const btnNo = document.getElementById("voucher-no");

        let pendingVoucher = null;

        function openConfirm(voucher) {
          pendingVoucher = voucher;
          confirmText.textContent = `Do you want to use "${voucher.label}" now?`;
          confirmPopup.classList.add("show");
          confirmPopup.setAttribute("aria-hidden", "false");
        }

        function closeConfirm() {
          pendingVoucher = null;
          confirmPopup.classList.remove("show");
          confirmPopup.setAttribute("aria-hidden", "true");
        }

        confirmPopup.addEventListener("click", (e) => {
          if (e.target === confirmPopup) closeConfirm();
        });

        btnNo.addEventListener("click", closeConfirm);

        btnYes.addEventListener("click", () => {
          if (!pendingVoucher) return;

          const minSpend = Number(pendingVoucher.minSpend || 0);
          const checkoutTotal = getCheckoutTotal();
          const totalForCheck = Number.isFinite(checkoutTotal)
            ? checkoutTotal
            : 0;

          if (minSpend > 0 && totalForCheck < minSpend) {
            closeConfirm();
            showPopup(
              `You can't use this since your items don't add up to $${minSpend}.`,
            );
            return;
          }

          sessionStorage.setItem(
            APPLIED_VOUCHER_KEY,
            JSON.stringify(pendingVoucher),
          );

          if (pendingVoucher.id) {
            usedVoucherIds.add(pendingVoucher.id);
            setJSON(VOUCHER_USED_KEY, Array.from(usedVoucherIds));

            const card = document.querySelector(
              `.card[data-reward-id="${pendingVoucher.id}"]`,
            );
            if (card) applyVoucherUsedState(card);
          }

          notifyNewReward(
            "ShiokLah! Voucher Selected ‚úÖ",
            `${pendingVoucher.label} will be applied at checkout.`,
          );

          window.location.href = CHECKOUT_PAGE;
        });

        function bindVoucherButtons() {
          document.querySelectorAll(".use-voucher-btn").forEach((btn) => {
            if (btn.dataset.bound === "1") return;
            btn.dataset.bound = "1";

            btn.addEventListener("click", async () => {
              await ensureNotificationsAllowed();

              const card = btn.closest(".card");
              if (!card) return;

              if (card.classList.contains("locked")) return;
              if (card.classList.contains("used")) return;

              const type = card.getAttribute("data-voucher-type") || "fixed";
              const rawValue = Number(
                card.getAttribute("data-voucher-value") || "0",
              );
              const minSpend = Number(
                card.getAttribute("data-voucher-min") || "0",
              );

              const voucherObj = {
                id: card.getAttribute("data-reward-id") || "",
                label: card.getAttribute("data-voucher-name") || "Voucher",
                code: card.getAttribute("data-voucher-code") || "",
                type: type === "percent" ? "percent" : "fixed",
                amount: type === "percent" ? rawValue / 100 : rawValue,
                minSpend,
                selectedAt: new Date().toISOString(),
              };

              openConfirm(voucherObj);
            });
          });
        }

        bindVoucherButtons();

        /* ‚úÖ MOBILE NAV open/close */
        const hamburger = document.getElementById("hamburger");
        const menu = document.getElementById("menu");
        const overlay = document.getElementById("navOverlay");

        if (hamburger && menu && overlay) {
          const closeMenu = () => {
            menu.classList.remove("show");
            overlay.classList.remove("show");
            document.body.style.overflow = "";
          };

          hamburger.addEventListener("click", () => {
            menu.classList.toggle("show");
            overlay.classList.toggle("show");
            document.body.style.overflow = menu.classList.contains("show")
              ? "hidden"
              : "";
          });

          overlay.addEventListener("click", closeMenu);

          hamburger.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") hamburger.click();
          });

          menu.querySelectorAll("a").forEach((a) => {
            a.addEventListener("click", closeMenu);
          });
        }
      });
    </script>
  </body>
</html>
