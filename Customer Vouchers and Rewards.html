<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rewards Page</title>
    <link rel="stylesheet" href="Master_page_stylesheet.css" />

    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }

      :root {
        --primary-orange: #e47329;
        --primary-yellow: #ffd400;
        --grey-lock: #eee;
        --grey-text: #888;
      }

      body {
        background: #fff;
        color: #222;
      }

      /* NAVIGATION */
      .navrectangle {
        background: white;
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 10px 40px;
        border-bottom: 1px solid #eee;
      }

      .top-nav {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
      }

      .Logo {
        height: 60px;
        display: flex;
        align-items: center;
      }

      .Logo img {
        height: 100%;
        width: auto;
      }

      .menu {
        display: flex;
        justify-content: center;
        list-style: none;
        gap: 50px;
      }

      .menu a {
        text-decoration: none;
        font-weight: 700;
        color: #111;
      }

      .menu a:hover {
        color: var(--primary-orange);
      }

      .menu-item {
        position: relative;
      }

      .dropdown {
        position: absolute;
        top: 130%;
        left: 0;
        background: var(--primary-yellow);
        border-radius: 12px;
        padding: 10px 0;
        min-width: 160px;
        display: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .dropdown li {
        list-style: none;
      }

      .dropdown a {
        display: block;
        padding: 10px 18px;
        color: #111;
      }

      .dropdown a:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      .menu-item:hover .dropdown {
        display: block;
      }

      /* MAIN REWARDS */
      main {
        padding: 50px 20px 60px;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
      }

      .subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 40px;
      }

      /* stable layout */
      .rewards-container {
        max-width: 1100px;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, minmax(260px, 1fr));
        gap: 25px;
        align-items: start;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s;
        min-height: 280px;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .icon {
        font-size: 45px;
        margin-bottom: 15px;
        color: var(--primary-orange);
      }

      .card h2 {
        color: var(--primary-orange);
        margin-bottom: 10px;
      }

      .card p {
        color: #444;
        margin-bottom: 20px;
        font-size: 15px;
      }

      .btn {
        background: var(--primary-orange);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      .code-box {
        border: 2px dashed var(--primary-orange);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: bold;
        color: var(--primary-orange);
      }

      /* LOCKED */
      .card.locked {
        background: var(--grey-lock);
        color: var(--grey-text);
      }
      .card.locked h2,
      .card.locked p,
      .card.locked .icon,
      .card.locked .code-box {
        color: var(--grey-text) !important;
        border-color: #bbb !important;
      }
      .btn.locked {
        background: var(--grey-lock);
        color: var(--grey-text);
        cursor: not-allowed;
      }

      /* USED (same grey as locked) */
      .card.used {
        background: var(--grey-lock) !important;
        color: var(--grey-text) !important;
      }
      .card.used h2,
      .card.used p,
      .card.used .icon,
      .card.used .code-box {
        color: var(--grey-text) !important;
        border-color: #bbb !important;
      }
      .card.used .btn {
        background: var(--grey-lock) !important;
        color: var(--grey-text) !important;
        cursor: not-allowed !important;
      }

      /* POPUP */
      .reward-popup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
      }

      .reward-popup.show {
        display: flex;
      }

      .popup-card {
        width: 100%;
        max-width: 360px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25);
        padding: 24px 22px;
        text-align: center;
        transform: scale(0.92);
        opacity: 0;
        transition: all 0.25s ease;
      }

      .reward-popup.show .popup-card {
        transform: scale(1);
        opacity: 1;
      }

      .popup-card h3 {
        color: var(--primary-orange);
        margin-bottom: 10px;
      }

      .popup-card p {
        margin-bottom: 18px;
        color: #333;
      }

      .popup-close {
        background: var(--primary-orange);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: bold;
      }

      /* WHEEL */
      .wheel-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 10px auto 14px;
      }

      #wheel {
        width: 300px;
        height: 300px;
        border-radius: 50%;
        display: block;
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.22);
      }

      /* pointer on RIGHT */
      #wheel-pointer {
        position: absolute;
        top: 50%;
        right: -18px;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 14px solid transparent;
        border-bottom: 14px solid transparent;
        border-left: 22px solid #2ecc71;
        filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2));
      }

      #card-spin {
        order: 9999;
      }

      /* REFER */
      .refer {
        margin: 60px auto 0;
        max-width: 1100px;
        background: linear-gradient(135deg, #e47329, #ff944d);
        color: white;
        padding: 30px;
        border-radius: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .refer button {
        background: white;
        color: var(--primary-orange);
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
      }

      /* MOBILE */
      @media (max-width: 980px) {
        .rewards-container {
          grid-template-columns: repeat(2, minmax(260px, 1fr));
        }
      }
      @media (max-width: 700px) {
        .menu {
          display: none;
        }
        .rewards-container {
          grid-template-columns: 1fr;
        }
      }

      /* =========================================================
         ADDED: TERMS & CONDITIONS POPUP (does NOT touch your layout)
      ========================================================= */
      .terms-card {
        max-width: 780px; /* wider for reading */
        text-align: left; /* readable */
      }

      .terms-meta {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
      }

      .terms-scroll {
        max-height: 60vh;
        overflow: auto;
        padding-right: 6px;
        margin: 12px 0 16px;
      }

      .terms-scroll h4 {
        margin: 14px 0 6px;
        color: #111;
        font-size: 15px;
      }

      .terms-scroll p,
      .terms-scroll li {
        font-size: 14px;
        line-height: 1.55;
        color: #333;
      }

      .terms-scroll ul {
        margin: 6px 0 10px 18px;
      }

      .terms-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .terms-actions .popup-close {
        margin: 0;
      }

      .terms-actions .btn-secondary {
        background: #fff;
        color: var(--primary-orange);
        border: 2px solid var(--primary-orange);
        padding: 10px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: bold;
      }

      .terms-actions .btn-secondary:hover {
        filter: brightness(0.98);
      }
    </style>
  </head>

  <body>
    <!-- NAVIGATION -->
    <nav class="navrectangle">
      <header class="top-nav">
        <div class="Logo">
          <img src="/images/ShiokLah(cropped).jpeg" alt="Logo" />
        </div>

        <nav>
          <ul class="menu">
            <li class="menu-item">
              <a href="FED_ASG.html">Home</a>
              <ul class="dropdown">
                <li><a href="#">Start Order</a></li>
              </ul>
            </li>

            <li class="menu-item">
              <a href="#">Order History</a>
              <ul class="dropdown">
                <li><a href="OrderHistory.html">Past Orders</a></li>
              </ul>
            </li>

            <li class="menu-item">
              <a href="#">Profile</a>
              <ul class="dropdown">
                <li><a href="UserProfile.html">Overview</a></li>
                <li><a href="Analytics.html">Analytics & Reporting</a></li>
                <li><a href="CustomerFeedback.html">Customer Feedback</a></li>
                <li>
                  <a href="Regulatory&Complianceinfo.html"
                    >Regulatory & Compliance</a
                  >
                </li>
                <li><a href="#">Favourites</a></li>
                <li>
                  <a href="Customer Vouchers and Rewards.html">Rewards</a>
                </li>
              </ul>
            </li>

            <li class="menu-item"><a href="login.html">Log Out</a></li>
          </ul>
        </nav>
      </header>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
      <h1>üéÅ Rewards</h1>
      <p class="subtitle">Unlock exclusive offers just for you</p>

      <div class="rewards-container" id="rewards-grid">
        <!-- Existing rewards -->
        <div class="card" data-reward-id="discount-20">
          <div class="icon">üè∑Ô∏è</div>
          <h2>20% OFF</h2>
          <p>Get 20% off your next order</p>
          <button class="btn use-btn">Use now</button>
        </div>

        <div class="card" data-reward-id="gift-10">
          <div class="icon">üéÅ</div>
          <h2>$10 Gift Card</h2>
          <p>Redeem a $10 gift card</p>
          <button class="btn use-btn">Use now</button>
        </div>

        <div class="card locked" data-reward-id="save-15">
          <div class="icon">‚úÇÔ∏è</div>
          <h2>Save $15</h2>
          <p>Finish 3 more reviews to unlock this</p>
          <div class="code-box">SAVE15</div>
          <button class="btn locked" disabled>You can't use this yet</button>
        </div>

        <div class="card locked" data-reward-id="free-takeaway">
          <div class="icon">üöö</div>
          <h2>Free Takeaway</h2>
          <p>Buy 3 items from 3 different stalls to unlock this</p>
          <button class="btn locked" disabled>You can't use this yet</button>
        </div>

        <div class="card" data-reward-id="bonus-points">
          <div class="icon">üí∞</div>
          <h2>Bonus Points</h2>
          <p>Get extra points on your next purchase</p>
          <button class="btn use-btn">Use now</button>
        </div>

        <!-- Lucky Spin (always last) -->
        <div class="card" id="card-spin">
          <div class="icon">üé°</div>
          <h2>Lucky Spin</h2>
          <p>Spin & win exciting prizes</p>

          <div class="wheel-container">
            <canvas id="wheel" width="300" height="300"></canvas>
            <div id="wheel-pointer" aria-hidden="true"></div>
          </div>

          <button class="btn" id="lucky-spin">Spin</button>
          <p
            id="spin-timer"
            style="font-size: 14px; color: #555; margin-top: 10px"
          ></p>
        </div>
      </div>

      <div class="refer">
        <h2>Terms and Conditions</h2>
        <!-- ADDED: id so JS can open the terms popup -->
        <button id="open-terms">Read</button>
      </div>
    </main>

    <!-- POPUP -->
    <div class="reward-popup" id="reward-popup">
      <div class="popup-card">
        <h3 id="popup-title">You won!</h3>
        <p id="popup-text"></p>
        <button class="popup-close" id="popup-close">Nice!</button>
      </div>
    </div>

    <!-- =========================================================
         ADDED: TERMS & CONDITIONS POPUP (new modal)
         - Uses the SAME .reward-popup overlay class you already have
         - Only ADDITION, does not modify your existing popup
    ========================================================= -->
    <div class="reward-popup" id="terms-popup" aria-hidden="true">
      <div
        class="popup-card terms-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="terms-title"
      >
        <h3 id="terms-title">ShiokLah! Rewards ‚Äì Terms & Conditions</h3>
        <div class="terms-meta">
          Last updated: <b>7 Feb 2026</b> ‚Ä¢ Applies to vouchers, points,
          promotions and Lucky Spin
        </div>

        <div class="terms-scroll" id="terms-scroll">
          <h4>1. Who we are</h4>
          <p>
            ShiokLah! (‚Äú<b>ShiokLah</b>‚Äù, ‚Äú<b>we</b>‚Äù, ‚Äú<b>us</b>‚Äù) is a hawker
            centre ordering platform that connects customers with participating
            stalls. These Terms & Conditions (‚Äú<b>Terms</b>‚Äù) govern your access
            to and use of the Rewards page, vouchers, coupons, points,
            promotions, referrals, and Lucky Spin (collectively, ‚Äú<b
              >Rewards Features</b
            >‚Äù).
          </p>

          <h4>2. Eligibility</h4>
          <ul>
            <li>
              You must have a ShiokLah account and be able to place orders using
              the app or website.
            </li>
            <li>
              Rewards Features are intended for genuine, personal use by end
              customers (not resellers or commercial buyers).
            </li>
            <li>
              We may require verification steps if we suspect abnormal activity
              or policy breaches.
            </li>
          </ul>

          <h4>3. Definitions</h4>
          <ul>
            <li>
              <b>Voucher / Coupon</b>: a promotional benefit that may reduce
              your payable amount, subject to conditions.
            </li>
            <li>
              <b>Points</b>: non-cash loyalty credits earned or granted through
              promotions, redeemable only as specified in-app.
            </li>
            <li>
              <b>Lucky Spin</b>: a random prize feature that may award vouchers
              or points, or a ‚ÄúTry Again‚Äù.
            </li>
            <li>
              <b>Participating Stalls</b>: stalls that appear in ShiokLah and
              accept ShiokLah orders.
            </li>
          </ul>

          <h4>4. General Rewards rules</h4>
          <ul>
            <li>
              Rewards have no cash value and cannot be exchanged for cash,
              topped up, or transferred unless the app explicitly allows it.
            </li>
            <li>
              Rewards are valid only within ShiokLah and only for participating
              stalls that accept the specific reward type.
            </li>
            <li>
              Rewards may be limited to one per transaction, unless stated
              otherwise.
            </li>
            <li>
              Rewards are subject to availability and may be withdrawn,
              replaced, or modified at any time to comply with legal or
              operational requirements.
            </li>
          </ul>

          <h4>5. Voucher usage & restrictions</h4>
          <ul>
            <li>
              Vouchers may require a <b>minimum spend</b>, may apply only to
              selected stalls/items, and may exclude delivery/service fees (if
              any are displayed at checkout).
            </li>
            <li>
              Vouchers generally cannot be stacked with other vouchers or
              promotions unless clearly stated in the voucher description.
            </li>
            <li>
              Vouchers must be used <b>before their expiry date/time</b>. Once
              expired, they cannot be reinstated.
            </li>
            <li>
              If you return/cancel an order (where cancellation is permitted),
              voucher reinstatement (if any) is at ShiokLah‚Äôs discretion and may
              depend on whether the stall has begun preparation.
            </li>
          </ul>

          <h4>6. ‚ÄúUse now‚Äù and ‚ÄúUsed‚Äù status</h4>
          <p>
            When you click ‚ÄúUse now‚Äù, the reward may be marked as ‚ÄúUsed‚Äù on this
            device to prevent accidental reuse. A ‚ÄúUsed‚Äù status may reflect
            completion of redemption, reservation/locking for a transaction, or
            a local record. Final redemption is confirmed at checkout and/or
            upon successful order payment.
          </p>

          <h4>7. Lucky Spin rules</h4>
          <ul>
            <li>Lucky Spin outcomes are randomly generated by the system.</li>
            <li>
              Cooldown periods may apply (e.g., <b>48 hours</b>) and are shown
              on the Rewards page. Changing devices, clearing storage, or using
              incognito mode may reset local timers but does not guarantee
              additional spins if server-side limits exist.
            </li>
            <li>
              ‚ÄúTry Again‚Äù grants an additional spin opportunity, but does not
              guarantee a voucher win.
            </li>
            <li>
              ShiokLah may adjust prize pools, odds, cooldowns, and eligibility
              criteria to prevent abuse and ensure fairness.
            </li>
          </ul>

          <h4>8. Points & loyalty</h4>
          <ul>
            <li>
              Points (including ‚ÄúBonus Points‚Äù) may be earned through qualifying
              purchases or awarded through promotions.
            </li>
            <li>
              Points may expire and may be forfeited if your account is inactive
              for an extended period or if misuse is detected.
            </li>
            <li>
              Points cannot be sold, transferred, or exchanged outside ShiokLah.
            </li>
          </ul>

          <h4>9. Referrals & promotions</h4>
          <ul>
            <li>
              Referral promotions (if shown) are for genuine new-user referrals.
              Self-referrals or bulk/automated invitations are not allowed.
            </li>
            <li>
              We may delay, reverse, or withhold referral rewards pending fraud
              checks or verification.
            </li>
            <li>
              Promotions may be limited by time, location, stall participation,
              user segment, and other conditions shown in-app.
            </li>
          </ul>

          <h4>10. Fraud, abuse, and prohibited activity</h4>
          <ul>
            <li>
              Do not attempt to exploit bugs, manipulate the Lucky Spin, create
              multiple accounts, or use automated scripts/bots.
            </li>
            <li>
              Do not buy/sell vouchers or points or attempt to trade them
              outside ShiokLah.
            </li>
            <li>
              If we reasonably suspect abuse, we may suspend rewards, remove
              vouchers/points, disable features, or restrict your account
              without prior notice.
            </li>
          </ul>

          <h4>11. Orders, stalls, and fulfilment</h4>
          <ul>
            <li>
              Stalls are independent merchants. Menu availability and pricing
              may change without notice.
            </li>
            <li>
              Stall fulfilment (preparation time, stock availability) may affect
              whether certain rewards can be applied to an order.
            </li>
            <li>
              If an item is unavailable, the stall may substitute, refund, or
              cancel (depending on stall policy and app options).
            </li>
          </ul>

          <h4>12. Liability & disclaimers</h4>
          <p>
            Rewards Features are provided on an ‚Äúas is‚Äù and ‚Äúas available‚Äù
            basis. To the maximum extent permitted by law, ShiokLah is not
            liable for losses arising from rewards availability, expiry, user
            error, device storage resets, or interruptions due to maintenance,
            network failures, or third-party issues.
          </p>

          <h4>13. Privacy</h4>
          <p>
            We may collect and use data related to reward redemptions and
            interactions to operate the program, prevent fraud, and improve user
            experience. Where applicable, notifications are shown only if you
            grant permission in your browser/device.
          </p>

          <h4>14. Changes to these Terms</h4>
          <p>
            We may update these Terms at any time. Updates will take effect once
            posted on this page. Your continued use of Rewards Features after
            changes means you accept the updated Terms.
          </p>

          <h4>15. Contact</h4>
          <p>
            If you have questions about rewards, expiry, or redemption issues,
            contact ShiokLah support through the app help section or your course
            project contact channel (for demo builds).
          </p>
        </div>

        <div class="terms-actions">
          <button class="btn-secondary" id="terms-scroll-top">
            Back to top
          </button>
          <button class="popup-close" id="terms-close">Close</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /***********************
         * SETTINGS
         ***********************/
        const ENABLE_COOLDOWN = true; // ‚úÖ ON
        const COOLDOWN_HOURS = 48; // ‚úÖ 48 hours

        /***********************
         * STORAGE KEYS
         ***********************/
        const USED_KEY = "shiok_used_rewards_v1";
        const EARNED_KEY = "shiok_earned_rewards_v1";
        const COOLDOWN_KEY = "shiok_spin_cooldown_v1";

        const getJSON = (k, fallback) => {
          try {
            const v = localStorage.getItem(k);
            return v ? JSON.parse(v) : fallback;
          } catch {
            return fallback;
          }
        };
        const setJSON = (k, val) =>
          localStorage.setItem(k, JSON.stringify(val));

        /***********************
         * POPUP
         ***********************/
        const popup = document.getElementById("reward-popup");
        const popupText = document.getElementById("popup-text");
        const popupClose = document.getElementById("popup-close");

        function showPopup(msg) {
          popupText.textContent = msg;
          popup.classList.add("show");
        }
        popupClose.addEventListener("click", () =>
          popup.classList.remove("show"),
        );
        popup.addEventListener("click", (e) => {
          if (e.target === popup) popup.classList.remove("show");
        });

        /***********************
         * ADDED: TERMS POPUP LOGIC (only additions)
         ***********************/
        const openTermsBtn = document.getElementById("open-terms");
        const termsPopup = document.getElementById("terms-popup");
        const termsCloseBtn = document.getElementById("terms-close");
        const termsScrollTopBtn = document.getElementById("terms-scroll-top");
        const termsScroll = document.getElementById("terms-scroll");

        function openTerms() {
          if (!termsPopup) return;
          termsPopup.classList.add("show");
          termsPopup.setAttribute("aria-hidden", "false");
        }

        function closeTerms() {
          if (!termsPopup) return;
          termsPopup.classList.remove("show");
          termsPopup.setAttribute("aria-hidden", "true");
        }

        if (openTermsBtn) openTermsBtn.addEventListener("click", openTerms);
        if (termsCloseBtn) termsCloseBtn.addEventListener("click", closeTerms);
        if (termsScrollTopBtn && termsScroll) {
          termsScrollTopBtn.addEventListener("click", () =>
            termsScroll.scrollTo({ top: 0, behavior: "smooth" }),
          );
        }
        if (termsPopup) {
          termsPopup.addEventListener("click", (e) => {
            if (e.target === termsPopup) closeTerms();
          });
        }

        /***********************
         * DESKTOP NOTIFICATION
         ***********************/
        function notifyNewReward(title, body) {
          if (!("Notification" in window)) return;

          if (Notification.permission === "granted") {
            new Notification(title, { body });
            return;
          }

          if (Notification.permission !== "denied") {
            Notification.requestPermission().then((perm) => {
              if (perm === "granted") new Notification(title, { body });
            });
          }
        }

        /***********************
         * USED (persist)
         ***********************/
        const usedIds = new Set(getJSON(USED_KEY, []));

        function applyUsedState(card, btn) {
          card.classList.add("used");
          if (btn) {
            btn.textContent = "Used";
            btn.disabled = true;
          }
        }

        // restore used state
        document.querySelectorAll(".card[data-reward-id]").forEach((card) => {
          const id = card.getAttribute("data-reward-id");
          const btn = card.querySelector(".use-btn");
          if (usedIds.has(id) && btn) applyUsedState(card, btn);
        });

        // click -> used
        document.querySelectorAll(".use-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const card = btn.closest(".card");
            const id = card?.getAttribute("data-reward-id");
            if (!card || !id) return;
            if (card.classList.contains("used")) return;

            applyUsedState(card, btn);
            usedIds.add(id);
            setJSON(USED_KEY, Array.from(usedIds));
          });
        });

        /***********************
         * EARNED REWARDS (from wheel)
         ***********************/
        const grid = document.getElementById("rewards-grid");
        const spinCard = document.getElementById("card-spin");
        const earnedRewards = getJSON(EARNED_KEY, []); // {id,title,desc,icon}

        function createEarnedCard(reward) {
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-reward-id", reward.id);

          card.innerHTML = `
            <div class="icon">${reward.icon}</div>
            <h2>${reward.title}</h2>
            <p>${reward.desc}</p>
            <button class="btn use-btn">Use now</button>
          `;

          const btn = card.querySelector(".use-btn");
          btn.addEventListener("click", () => {
            if (card.classList.contains("used")) return;
            applyUsedState(card, btn);
            usedIds.add(reward.id);
            setJSON(USED_KEY, Array.from(usedIds));
          });

          if (usedIds.has(reward.id)) applyUsedState(card, btn);
          return card;
        }

        // render earned on load (before spin card)
        earnedRewards.forEach((r) =>
          grid.insertBefore(createEarnedCard(r), spinCard),
        );

        function addEarnedReward(reward) {
          if (earnedRewards.some((r) => r.id === reward.id)) return; // no duplicates
          earnedRewards.push(reward);
          setJSON(EARNED_KEY, earnedRewards);
          grid.insertBefore(createEarnedCard(reward), spinCard);
        }

        /***********************
         * CONFETTI (bigger + more obvious)
         ***********************/
        function confettiBurst() {
          const colors = [
            "#FF9F1C",
            "#FFD166",
            "#06D6A0",
            "#4CC9F0",
            "#F72585",
          ];
          const count = 320;

          for (let i = 0; i < count; i++) {
            const p = document.createElement("div");
            const size = 6 + Math.random() * 10;

            p.style.position = "fixed";
            p.style.left = "50%";
            p.style.top = "25%";
            p.style.width = size + "px";
            p.style.height = size + "px";
            p.style.background =
              colors[Math.floor(Math.random() * colors.length)];
            p.style.borderRadius = Math.random() > 0.5 ? "50%" : "2px";
            p.style.zIndex = "9999";
            p.style.pointerEvents = "none";
            document.body.appendChild(p);

            const angle = Math.random() * Math.PI * 2;
            const power = 220 + Math.random() * 420;
            const dx = Math.cos(angle) * power;
            const dy = Math.sin(angle) * power - (180 + Math.random() * 120);
            const rotate = Math.random() * 900 - 450 + "deg";

            requestAnimationFrame(() => {
              p.style.transition =
                "transform 1.9s ease-out, opacity 1.9s ease-out";
              p.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate})`;
              p.style.opacity = "0";
            });

            setTimeout(() => p.remove(), 2000);
          }
        }

        /***********************
         * SPIN COOLDOWN (48h persist)
         ***********************/
        const spinBtn = document.getElementById("lucky-spin");
        const timerEl = document.getElementById("spin-timer");

        function getCooldownEnd() {
          const raw = localStorage.getItem(COOLDOWN_KEY);
          if (!raw) return null;
          const d = new Date(raw);
          return isNaN(d.getTime()) ? null : d;
        }
        function setCooldownEnd(dateObj) {
          localStorage.setItem(COOLDOWN_KEY, dateObj.toISOString());
        }
        function clearCooldown() {
          localStorage.removeItem(COOLDOWN_KEY);
        }

        function updateCooldownUI() {
          if (!ENABLE_COOLDOWN) {
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const end = getCooldownEnd();
          if (!end) {
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const diff = end - new Date();
          if (diff <= 0) {
            clearCooldown();
            timerEl.textContent = "";
            spinBtn.disabled = false;
            spinBtn.style.background = "";
            spinBtn.style.color = "";
            spinBtn.style.cursor = "pointer";
            return;
          }

          const h = Math.floor(diff / (1000 * 60 * 60));
          const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((diff % (1000 * 60)) / 1000);

          timerEl.textContent = `Next spin in: ${h}h ${m}m ${s}s`;
          spinBtn.disabled = true;
          spinBtn.style.background = "var(--grey-lock)";
          spinBtn.style.color = "var(--grey-text)";
          spinBtn.style.cursor = "not-allowed";
        }

        setInterval(updateCooldownUI, 1000);
        updateCooldownUI();

        /***********************
         * WHEEL
         ***********************/
        const wheel = document.getElementById("wheel");
        const ctx = wheel.getContext("2d");
        const radius = wheel.width / 2;

        const prizes = [
          {
            key: "5",
            title: "$5 Voucher",
            desc: "Use $5 off your next order",
            icon: "üíµ",
          },
          {
            key: "try",
            title: "Try Again",
            desc: "You get a second chance to spin!",
            icon: "üîÅ",
          },
          {
            key: "10",
            title: "$10 Voucher",
            desc: "Use $10 off your next order",
            icon: "üíµ",
          },
          {
            key: "points",
            title: "Bonus Points",
            desc: "Get extra points on your next purchase",
            icon: "üí∞",
          },
          {
            key: "15",
            title: "$15 Voucher",
            desc: "Use $15 off your next order",
            icon: "üíµ",
          },
        ];

        function drawWheel() {
          const colors = [
            "#2d6cdf",
            "#ff3ea5",
            "#e53935",
            "#ffd400",
            "#1f8b2e",
          ];
          const slice = (2 * Math.PI) / prizes.length;

          ctx.clearRect(0, 0, wheel.width, wheel.height);

          for (let i = 0; i < prizes.length; i++) {
            const start = i * slice;
            const end = start + slice;

            ctx.beginPath();
            ctx.moveTo(radius, radius);
            ctx.arc(radius, radius, radius, start, end);
            ctx.closePath();
            ctx.fillStyle = colors[i];
            ctx.fill();

            ctx.lineWidth = 4;
            ctx.strokeStyle = "rgba(255,255,255,0.9)";
            ctx.stroke();

            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(start + slice / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 16px Segoe UI";
            ctx.fillText(
              prizes[i].title.replace("Voucher", ""),
              radius - 16,
              6,
            );
            ctx.restore();
          }

          ctx.beginPath();
          ctx.arc(radius, radius, 42, 0, Math.PI * 2);
          ctx.fillStyle = "#fff";
          ctx.fill();
        }

        drawWheel();

        let spinning = false;

        spinBtn.addEventListener("click", () => {
          if (spinning) return;
          if (spinBtn.disabled) return;

          spinning = true;

          const selectedIndex = Math.floor(Math.random() * prizes.length);
          const sliceAngle = 360 / prizes.length;

          // pointer is on RIGHT (0 degrees). Put winning slice center at 0 degrees.
          const targetDeg = selectedIndex * sliceAngle + sliceAngle / 2;
          const turns = 6;
          const rotation = turns * 360 - targetDeg;

          wheel.style.transition = "transform 4s cubic-bezier(.17,.67,.12,.99)";
          wheel.style.transform = `rotate(${rotation}deg)`;

          wheel.addEventListener(
            "transitionend",
            function handler() {
              wheel.removeEventListener("transitionend", handler);
              wheel.style.transition = "";

              const reward = prizes[selectedIndex];

              // Only show popup AFTER stop
              if (reward.key === "try") {
                showPopup("You get a second chance to spin!");
                // no cooldown
              } else {
                const rewardId = `spin-${reward.key}`;

                addEarnedReward({
                  id: rewardId,
                  title: reward.title,
                  desc: reward.desc,
                  icon: reward.icon,
                });

                confettiBurst();
                showPopup(`You won: ${reward.title}! üéâ`);
                notifyNewReward(
                  "ShiokLah! Reward Unlocked üéÅ",
                  `You received: ${reward.title}`,
                );

                if (ENABLE_COOLDOWN) {
                  const end = new Date(
                    Date.now() + COOLDOWN_HOURS * 60 * 60 * 1000,
                  );
                  setCooldownEnd(end);
                  updateCooldownUI();
                }
              }

              spinning = false;
            },
            { once: true },
          );
        });
      });
    </script>
  </body>
</html>
